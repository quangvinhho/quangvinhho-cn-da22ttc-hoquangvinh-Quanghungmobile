<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>T√†i kho·∫£n c·ªßa t√¥i - QuangH∆∞ng Mobile</title>
    
    <!-- Google Fonts - Roboto & Montserrat (T·ªëi ∆∞u Typography) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700;900&family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
      * {
        font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      }
      
      :root {
        --red-main: #e41e26;
        --red-dark: #c5111a;
      }
      
      /* Christmas Banner Styles */
      .christmas-banner {
        background: linear-gradient(180deg, #0c1445 0%, #1a237e 30%, #1565c0 60%, #4fc3f7 100%);
        position: relative;
        overflow: hidden;
        min-height: 180px;
      }
      
      /* Stars twinkling */
      .stars {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
      }
      
      .star {
        position: absolute;
        width: 3px;
        height: 3px;
        background: #fff;
        border-radius: 50%;
        animation: twinkleStar 2s ease-in-out infinite;
      }
      
      @keyframes twinkleStar {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.5); }
      }
      
      /* Moon */
      .moon {
        position: absolute;
        top: 15px;
        right: 10%;
        width: 60px;
        height: 60px;
        background: radial-gradient(circle at 30% 30%, #fffde7, #fff9c4, #fff59d);
        border-radius: 50%;
        box-shadow: 0 0 40px rgba(255, 249, 196, 0.8), 0 0 80px rgba(255, 249, 196, 0.4);
        z-index: 1;
      }
      
      /* Snow ground */
      .snow-ground {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 40px;
        background: linear-gradient(180deg, rgba(255,255,255,0.9) 0%, #fff 100%);
        border-radius: 100% 100% 0 0;
        z-index: 2;
      }
      
      .snow-ground::before {
        content: '';
        position: absolute;
        bottom: 30px;
        left: 5%;
        width: 90%;
        height: 20px;
        background: linear-gradient(180deg, transparent 0%, rgba(255,255,255,0.5) 100%);
        border-radius: 100%;
      }
      
      /* Christmas Trees */
      .trees {
        position: absolute;
        bottom: 25px;
        left: 0;
        right: 0;
        height: 80px;
        z-index: 3;
        pointer-events: none;
      }
      
      .tree {
        position: absolute;
        bottom: 0;
        font-size: 2.5em;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
      }
      
      .tree:nth-child(1) { left: 2%; font-size: 2em; }
      .tree:nth-child(2) { left: 8%; font-size: 3em; }
      .tree:nth-child(3) { left: 15%; font-size: 2.2em; }
      .tree:nth-child(4) { right: 3%; font-size: 2.8em; }
      .tree:nth-child(5) { right: 10%; font-size: 2em; }
      .tree:nth-child(6) { right: 18%; font-size: 2.5em; }
      
      /* Santa Sleigh with Reindeers */
      .sleigh-container {
        position: absolute;
        top: 25%;
        left: -400px;
        z-index: 10;
        animation: flySleigh 12s linear infinite;
        filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
      }
      
      @keyframes flySleigh {
        0% { 
          left: -400px; 
          top: 30%;
        }
        25% { 
          top: 20%;
        }
        50% { 
          top: 35%;
        }
        75% { 
          top: 25%;
        }
        100% { 
          left: 110%; 
          top: 30%;
        }
      }
      
      .sleigh-group {
        display: flex;
        align-items: center;
        gap: 0;
      }
      
      .reindeer {
        font-size: 2.2em;
        animation: runReindeer 0.3s ease-in-out infinite alternate;
        display: inline-block;
      }
      
      .reindeer:nth-child(2) { animation-delay: 0s; }
      .reindeer:nth-child(3) { animation-delay: 0.1s; }
      .reindeer:nth-child(4) { animation-delay: 0.2s; }
      .reindeer:nth-child(5) { animation-delay: 0.15s; }
      
      @keyframes runReindeer {
        0% { transform: scaleX(-1) translateY(0) rotate(-5deg); }
        100% { transform: scaleX(-1) translateY(-8px) rotate(5deg); }
      }
      
      .sleigh {
        font-size: 3em;
        margin-right: -15px;
        animation: bounceSleigh 0.5s ease-in-out infinite alternate;
      }
      
      @keyframes bounceSleigh {
        0% { transform: translateY(0) rotate(-2deg); }
        100% { transform: translateY(-5px) rotate(2deg); }
      }
      
      .magic-trail {
        position: absolute;
        top: 50%;
        right: 0;
        transform: translateX(100%);
        display: flex;
        gap: 8px;
      }
      
      .sparkle {
        font-size: 0.8em;
        animation: sparkleTrail 0.8s ease-out infinite;
        opacity: 0;
      }
      
      .sparkle:nth-child(1) { animation-delay: 0s; }
      .sparkle:nth-child(2) { animation-delay: 0.15s; }
      .sparkle:nth-child(3) { animation-delay: 0.3s; }
      .sparkle:nth-child(4) { animation-delay: 0.45s; }
      .sparkle:nth-child(5) { animation-delay: 0.6s; }
      
      @keyframes sparkleTrail {
        0% { opacity: 1; transform: scale(1); }
        100% { opacity: 0; transform: scale(0.3) translateX(20px); }
      }
      
      /* Snowfall Effect - Enhanced */
      .snowflakes {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
        z-index: 5;
      }
      
      .snowflake {
        position: absolute;
        top: -10px;
        color: #fff;
        font-size: 1em;
        text-shadow: 0 0 10px rgba(255,255,255,1);
        animation: snowfall linear infinite;
        opacity: 0.95;
      }
      
      @keyframes snowfall {
        0% {
          transform: translateY(-10px) rotate(0deg) translateX(0);
          opacity: 1;
        }
        50% {
          transform: translateY(75px) rotate(180deg) translateX(20px);
        }
        100% {
          transform: translateY(180px) rotate(360deg) translateX(-10px);
          opacity: 0.5;
        }
      }
      
      .snowflake:nth-child(1) { left: 3%; animation-duration: 4s; animation-delay: 0s; font-size: 1.2em; }
      .snowflake:nth-child(2) { left: 10%; animation-duration: 5s; animation-delay: 0.5s; font-size: 0.8em; }
      .snowflake:nth-child(3) { left: 17%; animation-duration: 4.5s; animation-delay: 1s; font-size: 1.4em; }
      .snowflake:nth-child(4) { left: 24%; animation-duration: 5.5s; animation-delay: 0.3s; font-size: 0.6em; }
      .snowflake:nth-child(5) { left: 31%; animation-duration: 4.2s; animation-delay: 1.5s; font-size: 1.1em; }
      .snowflake:nth-child(6) { left: 38%; animation-duration: 5.2s; animation-delay: 0.8s; font-size: 0.9em; }
      .snowflake:nth-child(7) { left: 45%; animation-duration: 4.8s; animation-delay: 2s; font-size: 1.3em; }
      .snowflake:nth-child(8) { left: 52%; animation-duration: 4.3s; animation-delay: 0.2s; font-size: 0.7em; }
      .snowflake:nth-child(9) { left: 59%; animation-duration: 5.8s; animation-delay: 1.2s; font-size: 1em; }
      .snowflake:nth-child(10) { left: 66%; animation-duration: 4.6s; animation-delay: 0.7s; font-size: 1.5em; }
      .snowflake:nth-child(11) { left: 73%; animation-duration: 5.1s; animation-delay: 1.8s; font-size: 0.8em; }
      .snowflake:nth-child(12) { left: 80%; animation-duration: 4.4s; animation-delay: 2.2s; font-size: 1.2em; }
      .snowflake:nth-child(13) { left: 87%; animation-duration: 5.4s; animation-delay: 0.4s; font-size: 0.6em; }
      .snowflake:nth-child(14) { left: 94%; animation-duration: 4.7s; animation-delay: 1.6s; font-size: 1.1em; }
      .snowflake:nth-child(15) { left: 7%; animation-duration: 5.6s; animation-delay: 2.5s; font-size: 0.9em; }
      .snowflake:nth-child(16) { left: 21%; animation-duration: 4.1s; animation-delay: 0.9s; font-size: 1.3em; }
      .snowflake:nth-child(17) { left: 35%; animation-duration: 5.3s; animation-delay: 1.4s; font-size: 0.7em; }
      .snowflake:nth-child(18) { left: 49%; animation-duration: 4.9s; animation-delay: 2.1s; font-size: 1em; }
      .snowflake:nth-child(19) { left: 63%; animation-duration: 5.7s; animation-delay: 0.6s; font-size: 1.4em; }
      .snowflake:nth-child(20) { left: 77%; animation-duration: 4.5s; animation-delay: 1.9s; font-size: 0.8em; }
      
      /* Christmas Lights - Enhanced */
      .christmas-lights {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 25px;
        z-index: 15;
        display: flex;
        justify-content: space-around;
        align-items: flex-start;
      }
      
      .light-string {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 8px;
        background: linear-gradient(90deg, transparent 0%, #333 5%, #333 95%, transparent 100%);
        border-radius: 0 0 50% 50%;
      }
      
      .light-bulb {
        width: 14px;
        height: 18px;
        border-radius: 50% 50% 50% 50%;
        margin-top: 6px;
        animation: glowLight 1s ease-in-out infinite;
        position: relative;
      }
      
      .light-bulb::before {
        content: '';
        position: absolute;
        top: -4px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background: #444;
        border-radius: 2px;
      }
      
      .light-bulb.red { background: radial-gradient(circle at 30% 30%, #ff6b6b, #e41e26); box-shadow: 0 0 15px #ff4444, 0 0 30px rgba(255,68,68,0.5); }
      .light-bulb.green { background: radial-gradient(circle at 30% 30%, #69f0ae, #00c853); box-shadow: 0 0 15px #44ff44, 0 0 30px rgba(68,255,68,0.5); animation-delay: 0.25s; }
      .light-bulb.gold { background: radial-gradient(circle at 30% 30%, #ffeb3b, #ffc107); box-shadow: 0 0 15px #ffd700, 0 0 30px rgba(255,215,0,0.5); animation-delay: 0.5s; }
      .light-bulb.blue { background: radial-gradient(circle at 30% 30%, #64b5f6, #1976d2); box-shadow: 0 0 15px #4444ff, 0 0 30px rgba(68,68,255,0.5); animation-delay: 0.75s; }
      .light-bulb.pink { background: radial-gradient(circle at 30% 30%, #f48fb1, #e91e63); box-shadow: 0 0 15px #ff69b4, 0 0 30px rgba(255,105,180,0.5); animation-delay: 0.33s; }
      
      @keyframes glowLight {
        0%, 100% { opacity: 1; filter: brightness(1.2); }
        50% { opacity: 0.6; filter: brightness(0.8); }
      }
      
      .banner-content {
        position: relative;
        z-index: 20;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      }
      
      .christmas-icon {
        display: inline-block;
        animation: bounce 2s ease-in-out infinite;
      }
      
      @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
      }
      
      .title-glow {
        text-shadow: 0 0 10px rgba(255,255,255,0.8), 0 0 20px rgba(255,215,0,0.6), 2px 2px 4px rgba(0,0,0,0.5);
      }
    </style>
  </head>
  <body class="bg-gray-50">
    
    <!-- Header Component -->
    <div id="header-placeholder"></div>
    
    <!-- Spacer for fixed header - Responsive -->
    <div class="h-[80px] md:h-[100px] lg:h-[140px]"></div>

    <!-- Christmas Banner -->
    <div class="christmas-banner text-white py-8">
      <!-- Stars -->
      <div class="stars">
        <div class="star" style="top: 10%; left: 5%;"></div>
        <div class="star" style="top: 20%; left: 15%; animation-delay: 0.5s;"></div>
        <div class="star" style="top: 8%; left: 25%; animation-delay: 1s;"></div>
        <div class="star" style="top: 25%; left: 35%; animation-delay: 0.3s;"></div>
        <div class="star" style="top: 12%; left: 45%; animation-delay: 0.8s;"></div>
        <div class="star" style="top: 18%; left: 55%; animation-delay: 1.2s;"></div>
        <div class="star" style="top: 5%; left: 65%; animation-delay: 0.6s;"></div>
        <div class="star" style="top: 22%; left: 75%; animation-delay: 1.5s;"></div>
        <div class="star" style="top: 15%; left: 40%; animation-delay: 0.2s;"></div>
        <div class="star" style="top: 28%; left: 20%; animation-delay: 0.9s;"></div>
      </div>
      
      <!-- Moon -->
      <div class="moon"></div>
      
      <!-- Christmas Lights -->
      <div class="christmas-lights">
        <div class="light-string"></div>
        <div class="light-bulb red"></div>
        <div class="light-bulb green"></div>
        <div class="light-bulb gold"></div>
        <div class="light-bulb blue"></div>
        <div class="light-bulb pink"></div>
        <div class="light-bulb red"></div>
        <div class="light-bulb green"></div>
        <div class="light-bulb gold"></div>
        <div class="light-bulb blue"></div>
        <div class="light-bulb pink"></div>
        <div class="light-bulb red"></div>
        <div class="light-bulb green"></div>
        <div class="light-bulb gold"></div>
        <div class="light-bulb blue"></div>
        <div class="light-bulb pink"></div>
      </div>
      
      <!-- Santa Sleigh with Reindeers -->
      <div class="sleigh-container">
        <div class="sleigh-group">
          <span class="sleigh">üéÖüõ∑</span>
          <span class="reindeer" style="transform: scaleX(-1);">ü¶å</span>
          <span class="reindeer" style="transform: scaleX(-1);">ü¶å</span>
          <span class="reindeer" style="transform: scaleX(-1);">ü¶å</span>
          <span class="reindeer" style="transform: scaleX(-1);">ü¶å</span>
        </div>
        <div class="magic-trail">
          <span class="sparkle">‚ú®</span>
          <span class="sparkle">‚≠ê</span>
          <span class="sparkle">‚ú®</span>
          <span class="sparkle">üí´</span>
          <span class="sparkle">‚ú®</span>
        </div>
      </div>
      
      <!-- Snowflakes -->
      <div class="snowflakes">
        <div class="snowflake">‚ùÑ</div>
        <div class="snowflake">‚ùÖ</div>
        <div class="snowflake">‚ùÜ</div>
        <div class="snowflake">‚ùÑ</div>
        <div class="snowflake">‚ùÖ</div>
        <div class="snowflake">‚ùÜ</div>
        <div class="snowflake">‚ùÑ</div>
        <div class="snowflake">‚ùÖ</div>
        <div class="snowflake">‚ùÜ</div>
        <div class="snowflake">‚ùÑ</div>
        <div class="snowflake">‚ùÖ</div>
        <div class="snowflake">‚ùÜ</div>
        <div class="snowflake">‚ùÑ</div>
        <div class="snowflake">‚ùÖ</div>
        <div class="snowflake">‚ùÜ</div>
        <div class="snowflake">‚ùÑ</div>
        <div class="snowflake">‚ùÖ</div>
        <div class="snowflake">‚ùÜ</div>
        <div class="snowflake">‚ùÑ</div>
        <div class="snowflake">‚ùÖ</div>
      </div>
      
      <!-- Christmas Trees -->
      <div class="trees">
        <span class="tree">üéÑ</span>
        <span class="tree">üå≤</span>
        <span class="tree">üéÑ</span>
        <span class="tree">üéÑ</span>
        <span class="tree">üå≤</span>
        <span class="tree">üéÑ</span>
      </div>
      
      <!-- Snow Ground -->
      <div class="snow-ground"></div>
      
      <div class="container mx-auto px-4 banner-content">
        <h1 class="text-3xl font-bold title-glow">
          <span class="christmas-icon">üéÑ</span> T√†i kho·∫£n c·ªßa t√¥i <span class="christmas-icon">üéÖ</span>
        </h1>
        <p class="text-blue-100 mt-2 text-lg">
          <span class="christmas-icon">üéÅ</span> Qu·∫£n l√Ω th√¥ng tin v√† ƒë∆°n h√†ng c·ªßa b·∫°n - Ch√∫c Gi√°ng Sinh An L√†nh! <span class="christmas-icon">‚≠ê</span>
        </p>
      </div>
    </div>

    <div class="container mx-auto px-4 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <div id="profile-sidebar"></div>

        <main class="lg:col-span-3">
          <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold">Th√¥ng tin c√° nh√¢n</h2>
              <button id="edit-profile-btn" onclick="toggleEditMode(true)" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition text-sm">
                <i class="fas fa-edit mr-1"></i>Ch·ªânh s·ª≠a
              </button>
            </div>

            <!-- VIEW MODE - Hi·ªÉn th·ªã th√¥ng tin (m·∫∑c ƒë·ªãnh) -->
            <div id="profile-view-mode" class="space-y-6">
              <!-- Avatar Display -->
              <div class="flex items-center gap-6 pb-6 border-b">
                <div class="relative">
                  <div id="view-avatar-preview" class="w-24 h-24 rounded-full bg-red-600 flex items-center justify-center overflow-hidden border-4 border-gray-200">
                    <span id="view-avatar-text" class="text-white text-2xl font-bold">U</span>
                    <img id="view-avatar-img" src="" alt="Avatar" class="w-full h-full object-cover hidden">
                  </div>
                </div>
                <div>
                  <h3 class="font-semibold text-gray-800">·∫¢nh ƒë·∫°i di·ªán</h3>
                  <p class="text-sm text-gray-500">Nh·∫•n "Ch·ªânh s·ª≠a" ƒë·ªÉ thay ƒë·ªïi</p>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-gray-500 text-sm mb-1">H·ªç v√† t√™n</label>
                  <p id="view-name" class="text-gray-800 font-medium text-lg">---</p>
                </div>
                <div>
                  <label class="block text-gray-500 text-sm mb-1">S·ªë ƒëi·ªán tho·∫°i</label>
                  <p id="view-phone" class="text-gray-800 font-medium text-lg">---</p>
                </div>
              </div>

              <div>
                <label class="block text-gray-500 text-sm mb-1">Email</label>
                <p id="view-email" class="text-gray-800 font-medium text-lg">---</p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-gray-500 text-sm mb-1">Gi·ªõi t√≠nh</label>
                  <p id="view-gender" class="text-gray-800 font-medium text-lg">---</p>
                </div>
                <div>
                  <label class="block text-gray-500 text-sm mb-1">Ng√†y sinh</label>
                  <p id="view-birthday" class="text-gray-800 font-medium text-lg">---</p>
                </div>
              </div>

              <div>
                <label class="block text-gray-500 text-sm mb-1">ƒê·ªãa ch·ªâ</label>
                <p id="view-address" class="text-gray-800 font-medium text-lg">---</p>
              </div>
            </div>

            <!-- EDIT MODE - Form ch·ªânh s·ª≠a (·∫©n m·∫∑c ƒë·ªãnh) -->
            <form id="profile-form" class="space-y-6 hidden" onsubmit="handleUpdateProfile(event)" enctype="multipart/form-data">
              <!-- Avatar Upload -->
              <div class="flex items-center gap-6 pb-6 border-b">
                <div class="relative">
                  <div id="profile-avatar-preview" class="w-24 h-24 rounded-full bg-red-600 flex items-center justify-center overflow-hidden border-4 border-gray-200">
                    <span id="profile-avatar-text" class="text-white text-2xl font-bold">U</span>
                    <img id="profile-avatar-img" src="" alt="Avatar" class="w-full h-full object-cover hidden">
                  </div>
                  <label for="profile-avatar" class="absolute bottom-0 right-0 bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center cursor-pointer hover:bg-red-700 transition shadow-lg">
                    <i class="fas fa-camera text-sm"></i>
                  </label>
                  <input type="file" id="profile-avatar" accept="image/*" class="hidden" onchange="previewProfileAvatar(this)">
                </div>
                <div>
                  <h3 class="font-semibold text-gray-800">·∫¢nh ƒë·∫°i di·ªán</h3>
                  <p class="text-sm text-gray-500">Nh·∫•n v√†o bi·ªÉu t∆∞·ª£ng camera ƒë·ªÉ thay ƒë·ªïi</p>
                  <p class="text-xs text-gray-400 mt-1">H·ªó tr·ª£: JPG, PNG, GIF (T·ªëi ƒëa 5MB)</p>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">H·ªç v√† t√™n</label>
                  <input type="text" id="profile-name" class="w-full px-4 py-3 border rounded-lg outline-none focus:border-red-600 transition" placeholder="Nh·∫≠p h·ªç v√† t√™n" />
                </div>
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">S·ªë ƒëi·ªán tho·∫°i</label>
                  <input type="tel" id="profile-phone" class="w-full px-4 py-3 border rounded-lg outline-none focus:border-red-600 transition" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" />
                </div>
              </div>

              <div>
                <label class="block text-gray-700 font-semibold mb-2">Email</label>
                <input type="email" id="profile-email" class="w-full px-4 py-3 border rounded-lg outline-none focus:border-red-600 transition bg-gray-100" readonly />
              </div>

              <div>
                <label class="block text-gray-700 font-semibold mb-2">Gi·ªõi t√≠nh</label>
                <div class="flex space-x-4">
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="gender" value="nam" class="w-4 h-4 text-red-600 focus:ring-red-500" />
                    <span class="ml-2 text-gray-700">Nam</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="gender" value="nu" class="w-4 h-4 text-red-600 focus:ring-red-500" />
                    <span class="ml-2 text-gray-700">N·ªØ</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="gender" value="khac" class="w-4 h-4 text-red-600 focus:ring-red-500" />
                    <span class="ml-2 text-gray-700">Kh√°c</span>
                  </label>
                </div>
              </div>

              <div>
                <label class="block text-gray-700 font-semibold mb-2">Ng√†y sinh</label>
                <input type="date" id="profile-birthday" class="w-full px-4 py-3 border rounded-lg outline-none focus:border-red-600 transition" />
              </div>

              <div>
                <label class="block text-gray-700 font-semibold mb-2">ƒê·ªãa ch·ªâ</label>
                <textarea id="profile-address" rows="3" class="w-full px-4 py-3 border rounded-lg outline-none focus:border-red-600 transition" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ..."></textarea>
              </div>

              <div class="flex space-x-4">
                <button type="submit" class="bg-red-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-red-700 transition">
                  <i class="fas fa-save mr-2"></i>L∆∞u thay ƒë·ªïi
                </button>
                <button type="button" onclick="toggleEditMode(false)" class="border-2 border-gray-300 text-gray-700 px-8 py-3 rounded-lg font-semibold hover:bg-gray-50 transition">
                  <i class="fas fa-times mr-2"></i>H·ªßy
                </button>
              </div>
            </form>
          </div>

          <div id="orders" class="bg-white rounded-lg shadow-md p-6 scroll-mt-32">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold">ƒê∆°n h√†ng c·ªßa t√¥i</h2>
              <span id="orders-count" class="text-gray-500 text-sm">0 ƒë∆°n h√†ng</span>
            </div>

            <!-- Orders List -->
            <div id="orders-list" class="space-y-4">
              <!-- Loading -->
              <div id="orders-loading" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-3"></i>
                <p class="text-gray-500">ƒêang t·∫£i ƒë∆°n h√†ng...</p>
              </div>
            </div>
            
            <!-- Empty State -->
            <div id="orders-empty" class="hidden text-center py-12">
              <i class="fas fa-shopping-bag text-6xl text-gray-300 mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-700 mb-2">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h3>
              <p class="text-gray-500 mb-4">H√£y mua s·∫Øm ƒë·ªÉ c√≥ ƒë∆°n h√†ng ƒë·∫ßu ti√™n!</p>
              <a href="products.html" class="inline-block bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition">
                <i class="fas fa-shopping-cart mr-2"></i>Mua s·∫Øm ngay
              </a>
            </div>
          </div>

          <!-- ƒê·ªãa ch·ªâ nh·∫≠n h√†ng -->
          <div id="address" class="bg-white rounded-lg shadow-md p-6 mb-6 scroll-mt-32">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold">ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</h2>
              <button onclick="openAddAddressModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
                <i class="fas fa-plus mr-1"></i>Th√™m ƒë·ªãa ch·ªâ m·ªõi
              </button>
            </div>

            <!-- Address List -->
            <div id="address-list" class="space-y-4">
              <!-- Loading -->
              <div id="address-loading" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-3"></i>
                <p class="text-gray-500">ƒêang t·∫£i ƒë·ªãa ch·ªâ...</p>
              </div>
            </div>
            
            <!-- Empty State -->
            <div id="address-empty" class="hidden text-center py-12">
              <i class="fas fa-map-marker-alt text-6xl text-gray-300 mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-700 mb-2">Ch∆∞a c√≥ ƒë·ªãa ch·ªâ nh·∫≠n h√†ng</h3>
              <p class="text-gray-500 mb-4">Th√™m ƒë·ªãa ch·ªâ ƒë·ªÉ mua h√†ng nhanh h∆°n!</p>
              <button onclick="openAddAddressModal()" class="inline-block bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition">
                <i class="fas fa-plus mr-2"></i>Th√™m ƒë·ªãa ch·ªâ m·ªõi
              </button>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Add/Edit Address Modal -->
    <div id="addressModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-red-600 to-red-700 p-4 text-white">
          <div class="flex items-center justify-between">
            <div>
              <h3 id="addressModalTitle" class="font-bold text-lg">Th√™m ƒë·ªãa ch·ªâ m·ªõi</h3>
              <p class="text-red-100 text-sm">Nh·∫≠p th√¥ng tin ng∆∞·ªùi nh·∫≠n h√†ng</p>
            </div>
            <button onclick="closeAddressModal()" class="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        
        <!-- Content -->
        <div class="p-4 max-h-[60vh] overflow-y-auto">
          <form id="addressForm" class="space-y-4">
            <input type="hidden" id="addressId" value="">
            
            <!-- H·ªç t√™n v√† SƒêT -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  H·ªç v√† t√™n <span class="text-red-500">*</span>
                </label>
                <input type="text" id="addr-fullname" placeholder="Nh·∫≠p h·ªç t√™n ng∆∞·ªùi nh·∫≠n" 
                  class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition">
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  S·ªë ƒëi·ªán tho·∫°i <span class="text-red-500">*</span>
                </label>
                <input type="tel" id="addr-phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" 
                  class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition">
              </div>
            </div>
            
            <!-- T·ªânh/TP, Qu·∫≠n/Huy·ªán, Ph∆∞·ªùng/X√£ -->
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  T·ªânh/TP <span class="text-red-500">*</span>
                </label>
                <select id="addr-province" onchange="loadAddressDistricts()" 
                  class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition">
                  <option value="">Ch·ªçn T·ªânh/TP</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Qu·∫≠n/Huy·ªán <span class="text-red-500">*</span>
                </label>
                <select id="addr-district" onchange="loadAddressWards()" 
                  class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition">
                  <option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Ph∆∞·ªùng/X√£ <span class="text-red-500">*</span>
                </label>
                <select id="addr-ward" 
                  class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition">
                  <option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>
                </select>
              </div>
            </div>
            
            <!-- ƒê·ªãa ch·ªâ c·ª• th·ªÉ -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                ƒê·ªãa ch·ªâ c·ª• th·ªÉ <span class="text-red-500">*</span>
              </label>
              <input type="text" id="addr-detail" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng..." 
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition">
            </div>
            
            <!-- Lo·∫°i ƒë·ªãa ch·ªâ -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Lo·∫°i ƒë·ªãa ch·ªâ</label>
              <div class="flex gap-4">
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="addr-type" value="nha_rieng" checked class="w-4 h-4 text-red-600 focus:ring-red-500">
                  <span class="ml-2 text-gray-700">
                    <i class="fas fa-home mr-1"></i>Nh√† ri√™ng
                  </span>
                </label>
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="addr-type" value="co_quan" class="w-4 h-4 text-red-600 focus:ring-red-500">
                  <span class="ml-2 text-gray-700">
                    <i class="fas fa-building mr-1"></i>C∆° quan
                  </span>
                </label>
              </div>
            </div>
            
            <!-- Set m·∫∑c ƒë·ªãnh -->
            <div class="flex items-center">
              <input type="checkbox" id="addr-default" class="w-4 h-4 text-red-600 focus:ring-red-500 rounded">
              <label for="addr-default" class="ml-2 text-gray-700 cursor-pointer">
                ƒê·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
              </label>
            </div>
          </form>
        </div>
        
        <!-- Footer -->
        <div class="p-4 border-t bg-gray-50 flex gap-2">
          <button onclick="closeAddressModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2.5 rounded-lg font-semibold transition">
            H·ªßy
          </button>
          <button onclick="saveAddress()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2.5 rounded-lg font-semibold transition">
            <i class="fas fa-save mr-1"></i>L∆∞u ƒë·ªãa ch·ªâ
          </button>
        </div>
      </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderDetailModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-red-600 to-red-700 p-4 text-white">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-bold text-lg">Chi ti·∫øt ƒë∆°n h√†ng</h3>
              <p id="modalOrderId" class="text-red-100 text-sm">---</p>
            </div>
            <button onclick="closeOrderModal()" class="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        
        <!-- Content -->
        <div class="p-4 max-h-[60vh] overflow-y-auto">
          <!-- Status -->
          <div class="flex items-center justify-between mb-4 pb-4 border-b">
            <span class="text-gray-600">Tr·∫°ng th√°i:</span>
            <span id="modalStatus" class="px-3 py-1 rounded-full text-sm font-semibold">---</span>
          </div>
          
          <!-- Products -->
          <div class="mb-4">
            <h4 class="font-semibold text-gray-800 mb-3">S·∫£n ph·∫©m ƒë√£ ƒë·∫∑t</h4>
            <div id="modalProducts" class="space-y-3">
              <!-- Products will be rendered here -->
            </div>
          </div>
          
          <!-- Customer Info -->
          <div class="bg-gray-50 rounded-lg p-3 mb-4">
            <h4 class="font-semibold text-gray-800 mb-2 text-sm">Th√¥ng tin giao h√†ng</h4>
            <p id="modalCustomer" class="text-sm text-gray-600">---</p>
            <p id="modalPhone" class="text-sm text-gray-600">---</p>
            <p id="modalAddress" class="text-sm text-gray-600">---</p>
          </div>
          
          <!-- Payment Info -->
          <div class="bg-red-50 rounded-lg p-3">
            <div class="flex justify-between items-center mb-2">
              <span class="text-gray-600 text-sm">Ph∆∞∆°ng th·ª©c:</span>
              <span id="modalPayment" class="font-semibold text-gray-800 text-sm">---</span>
            </div>
            <div class="flex justify-between items-center mb-2">
              <span class="text-gray-600 text-sm">Ph√≠ v·∫≠n chuy·ªÉn:</span>
              <span id="modalShipping" class="font-semibold text-gray-800 text-sm">---</span>
            </div>
            <div class="flex justify-between items-center mb-2">
              <span class="text-gray-600 text-sm">Gi·∫£m gi√°:</span>
              <span id="modalDiscount" class="font-semibold text-green-600 text-sm">---</span>
            </div>
            <div class="flex justify-between items-center pt-2 border-t border-red-200">
              <span class="font-bold text-gray-800">T·ªïng thanh to√°n:</span>
              <span id="modalTotal" class="font-bold text-red-600 text-xl">---</span>
            </div>
          </div>
        </div>
        
        <!-- Footer -->
        <div class="p-4 border-t bg-gray-50 flex gap-2">
          <button onclick="closeOrderModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2.5 rounded-lg font-semibold transition">
            ƒê√≥ng
          </button>
          <button id="modalReorderBtn" onclick="reorderFromModal()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2.5 rounded-lg font-semibold transition">
            <i class="fas fa-redo mr-1"></i>Mua l·∫°i
          </button>
        </div>
      </div>
    </div>

    <!-- Review Product Modal -->
    <div id="reviewProductModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-red-600 to-red-700 p-4 text-white">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-bold text-lg">ƒê√°nh gi√° s·∫£n ph·∫©m</h3>
              <p class="text-red-100 text-sm">Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n</p>
            </div>
            <button onclick="closeReviewModal()" class="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        
        <!-- Content -->
        <div class="p-4 max-h-[60vh] overflow-y-auto">
          <!-- Product Info -->
          <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg mb-4">
            <img id="reviewProductImage" src="" alt="" class="w-16 h-16 object-contain rounded border">
            <div class="flex-1 min-w-0">
              <h4 id="reviewProductName" class="font-semibold text-gray-800 text-sm truncate">---</h4>
              <p id="reviewProductVariant" class="text-xs text-gray-500">---</p>
            </div>
          </div>
          
          <!-- Rating -->
          <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">ƒê√°nh gi√° c·ªßa b·∫°n <span class="text-red-500">*</span></label>
            <div id="reviewRatingInput" class="flex gap-2 justify-center">
              <button type="button" onclick="setReviewRating(1)" class="text-3xl text-gray-300 hover:text-yellow-400 transition"><i class="far fa-star" data-rating="1"></i></button>
              <button type="button" onclick="setReviewRating(2)" class="text-3xl text-gray-300 hover:text-yellow-400 transition"><i class="far fa-star" data-rating="2"></i></button>
              <button type="button" onclick="setReviewRating(3)" class="text-3xl text-gray-300 hover:text-yellow-400 transition"><i class="far fa-star" data-rating="3"></i></button>
              <button type="button" onclick="setReviewRating(4)" class="text-3xl text-gray-300 hover:text-yellow-400 transition"><i class="far fa-star" data-rating="4"></i></button>
              <button type="button" onclick="setReviewRating(5)" class="text-3xl text-gray-300 hover:text-yellow-400 transition"><i class="far fa-star" data-rating="5"></i></button>
            </div>
            <p id="ratingText" class="text-center text-sm text-gray-500 mt-1">Ch·ªçn s·ªë sao</p>
          </div>
          
          <!-- Comment -->
          <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Nh·∫≠n x√©t <span class="text-red-500">*</span></label>
            <textarea id="reviewCommentInput" rows="4" placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ s·∫£n ph·∫©m n√†y..." class="w-full border border-gray-300 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none resize-none"></textarea>
          </div>
          
          <!-- Upload Images -->
          <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-camera mr-1"></i> Th√™m h√¨nh ·∫£nh (t·ªëi ƒëa 5 ·∫£nh)
            </label>
            <div class="flex items-center gap-3 flex-wrap">
              <label class="cursor-pointer flex items-center justify-center w-16 h-16 border-2 border-dashed border-gray-300 rounded-lg hover:border-red-500 hover:bg-red-50 transition">
                <input type="file" id="reviewImagesInput" accept="image/*" multiple class="hidden" onchange="previewReviewImagesProfile(this)" />
                <div class="text-center">
                  <i class="fas fa-plus text-gray-400"></i>
                </div>
              </label>
              <div id="reviewImagePreviewProfile" class="flex gap-2 flex-wrap"></div>
            </div>
          </div>
        </div>
        
        <!-- Footer -->
        <div class="p-4 border-t bg-gray-50">
          <button onclick="submitProductReview()" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2">
            <i class="fas fa-paper-plane"></i> G·ª≠i ƒë√°nh gi√°
          </button>
        </div>
      </div>
    </div>

    <!-- Cancel Order Modal -->
    <div id="cancelOrderModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-red-600 to-red-700 p-4 text-white">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-bold text-lg">H·ªßy ƒë∆°n h√†ng</h3>
              <p id="cancelOrderId" class="text-red-100 text-sm">---</p>
            </div>
            <button onclick="closeCancelModal()" class="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        
        <!-- Content -->
        <div class="p-4">
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
            <p class="text-yellow-800 text-sm">
              <i class="fas fa-exclamation-triangle mr-2"></i>
              <strong>L∆∞u √Ω:</strong> B·∫°n ch·ªâ c√≥ th·ªÉ h·ªßy ƒë∆°n h√†ng khi ƒë∆°n ƒëang ·ªü tr·∫°ng th√°i "Ch·ªù x·ª≠ l√Ω". Sau khi admin x√°c nh·∫≠n, b·∫°n s·∫Ω kh√¥ng th·ªÉ h·ªßy ƒë∆°n.
            </p>
          </div>
          
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            L√Ω do h·ªßy ƒë∆°n h√†ng <span class="text-red-500">*</span>
          </label>
          <select id="cancelReasonSelect" onchange="handleCancelReasonChange(this)" class="w-full border border-gray-300 rounded-lg px-4 py-3 mb-3 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none">
            <option value="">-- Ch·ªçn l√Ω do --</option>
            <option value="T√¥i mu·ªën thay ƒë·ªïi ƒë·ªãa ch·ªâ giao h√†ng">T√¥i mu·ªën thay ƒë·ªïi ƒë·ªãa ch·ªâ giao h√†ng</option>
            <option value="T√¥i mu·ªën thay ƒë·ªïi s·∫£n ph·∫©m">T√¥i mu·ªën thay ƒë·ªïi s·∫£n ph·∫©m</option>
            <option value="T√¥i ƒë·∫∑t nh·∫ßm s·∫£n ph·∫©m">T√¥i ƒë·∫∑t nh·∫ßm s·∫£n ph·∫©m</option>
            <option value="T√¥i kh√¥ng c√≤n nhu c·∫ßu mua n·ªØa">T√¥i kh√¥ng c√≤n nhu c·∫ßu mua n·ªØa</option>
            <option value="T√¥i t√¨m ƒë∆∞·ª£c gi√° t·ªët h∆°n ·ªü n∆°i kh√°c">T√¥i t√¨m ƒë∆∞·ª£c gi√° t·ªët h∆°n ·ªü n∆°i kh√°c</option>
            <option value="other">L√Ω do kh√°c...</option>
          </select>
          
          <textarea id="cancelReasonText" rows="3" placeholder="Nh·∫≠p l√Ω do h·ªßy ƒë∆°n h√†ng..." 
            class="hidden w-full border border-gray-300 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none resize-none"></textarea>
        </div>
        
        <!-- Footer -->
        <div class="p-4 border-t bg-gray-50 flex gap-2">
          <button onclick="closeCancelModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2.5 rounded-lg font-semibold transition">
            Quay l·∫°i
          </button>
          <button onclick="confirmCancelOrder()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2.5 rounded-lg font-semibold transition">
            <i class="fas fa-times mr-1"></i>X√°c nh·∫≠n h·ªßy
          </button>
        </div>
      </div>
    </div>

    <!-- Footer Component -->
    <div id="footer-placeholder"></div>

    <script>
      // Load header component
      fetch('components/header.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('header-placeholder').innerHTML = html;
          const script = document.createElement('script');
          script.src = 'components/header.js';
          document.body.appendChild(script);
        })
        .catch(error => console.error('Error loading header:', error));

      // Load profile sidebar component
      fetch('components/profile-sidebar.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('profile-sidebar').innerHTML = html;
          // Load user info v√†o sidebar sau khi HTML ƒë√£ ƒë∆∞·ª£c th√™m
          loadSidebarUser();
        })
        .catch(error => console.error('Error loading sidebar:', error));

      // Load footer component
      fetch('components/footer.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('footer-placeholder').innerHTML = html;
        })
        .catch(error => console.error('Error loading footer:', error));

      // ===== USER PROFILE FUNCTIONS =====
      const API_URL = 'http://localhost:3000/api';

      // Load th√¥ng tin user v√†o sidebar
      function loadSidebarUser() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        
        if (!user) {
          window.location.href = 'login.html';
          return;
        }
        
        // C·∫≠p nh·∫≠t t√™n v√† email
        const nameEl = document.getElementById('sidebar-user-name');
        const emailEl = document.getElementById('sidebar-user-email');
        if (nameEl) nameEl.textContent = user.ho_ten || 'Ng∆∞·ªùi d√πng';
        if (emailEl) emailEl.textContent = user.email || '';
        
        // C·∫≠p nh·∫≠t avatar
        const avatarText = document.getElementById('sidebar-avatar-text');
        const avatarImg = document.getElementById('sidebar-avatar-img');
        
        if (user.avt) {
          if (avatarImg) {
            avatarImg.src = user.avt;
            avatarImg.classList.remove('hidden');
            avatarImg.onerror = function() {
              this.classList.add('hidden');
              if (avatarText) avatarText.classList.remove('hidden');
            };
          }
          if (avatarText) avatarText.classList.add('hidden');
        } else {
          // Hi·ªÉn th·ªã ch·ªØ c√°i ƒë·∫ßu
          const initials = (user.ho_ten || 'U').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
          if (avatarText) {
            avatarText.textContent = initials;
            avatarText.classList.remove('hidden');
          }
          if (avatarImg) avatarImg.classList.add('hidden');
        }
      }

      // H√†m ƒëƒÉng xu·∫•t
      function handleLogout() {
        localStorage.removeItem('user');
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('isAdmin');
        alert('ƒêƒÉng xu·∫•t th√†nh c√¥ng!');
        window.location.href = 'index.html';
      }

      // Preview avatar khi ch·ªçn file m·ªõi
      function previewProfileAvatar(input) {
        if (input.files && input.files[0]) {
          const file = input.files[0];
          
          if (file.size > 5 * 1024 * 1024) {
            alert('·∫¢nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB!');
            input.value = '';
            return;
          }

          const reader = new FileReader();
          reader.onload = function(e) {
            const avatarImg = document.getElementById('profile-avatar-img');
            const avatarText = document.getElementById('profile-avatar-text');
            
            if (avatarImg) {
              avatarImg.src = e.target.result;
              avatarImg.classList.remove('hidden');
            }
            if (avatarText) avatarText.classList.add('hidden');
          };
          reader.readAsDataURL(file);
        }
      }

      // Toggle gi·ªØa View Mode v√† Edit Mode
      function toggleEditMode(isEdit) {
        const viewMode = document.getElementById('profile-view-mode');
        const editForm = document.getElementById('profile-form');
        const editBtn = document.getElementById('edit-profile-btn');
        
        if (isEdit) {
          // Chuy·ªÉn sang Edit Mode
          viewMode.classList.add('hidden');
          editForm.classList.remove('hidden');
          editBtn.classList.add('hidden');
          // Load d·ªØ li·ªáu v√†o form
          loadUserProfileForm();
        } else {
          // Chuy·ªÉn v·ªÅ View Mode
          viewMode.classList.remove('hidden');
          editForm.classList.add('hidden');
          editBtn.classList.remove('hidden');
          // Refresh view data
          loadUserProfileView();
        }
      }

      // Load th√¥ng tin user v√†o View Mode
      function loadUserProfileView() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        
        if (!user) {
          window.location.href = 'login.html';
          return;
        }
        
        // Hi·ªÉn th·ªã th√¥ng tin
        document.getElementById('view-name').textContent = user.ho_ten || '---';
        document.getElementById('view-phone').textContent = user.so_dt || '---';
        document.getElementById('view-email').textContent = user.email || '---';
        document.getElementById('view-address').textContent = user.dia_chi || '---';
        
        // Gi·ªõi t√≠nh
        const genderMap = { 'nam': 'Nam', 'nu': 'N·ªØ', 'khac': 'Kh√°c' };
        document.getElementById('view-gender').textContent = genderMap[user.gioi_tinh] || '---';
        
        // Ng√†y sinh
        if (user.ngay_sinh) {
          const date = new Date(user.ngay_sinh);
          document.getElementById('view-birthday').textContent = date.toLocaleDateString('vi-VN');
        } else {
          document.getElementById('view-birthday').textContent = '---';
        }
        
        // Avatar trong view mode
        const viewAvatarImg = document.getElementById('view-avatar-img');
        const viewAvatarText = document.getElementById('view-avatar-text');
        
        if (user.avt) {
          if (viewAvatarImg) {
            viewAvatarImg.src = user.avt;
            viewAvatarImg.classList.remove('hidden');
            viewAvatarImg.onerror = function() {
              this.classList.add('hidden');
              if (viewAvatarText) viewAvatarText.classList.remove('hidden');
            };
          }
          if (viewAvatarText) viewAvatarText.classList.add('hidden');
        } else {
          const initials = (user.ho_ten || 'U').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
          if (viewAvatarText) {
            viewAvatarText.textContent = initials;
            viewAvatarText.classList.remove('hidden');
          }
          if (viewAvatarImg) viewAvatarImg.classList.add('hidden');
        }
      }

      // Load th√¥ng tin user v√†o Form (Edit Mode)
      function loadUserProfileForm() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        
        if (!user) {
          window.location.href = 'login.html';
          return;
        }
        
        // ƒêi·ªÅn th√¥ng tin v√†o form
        document.getElementById('profile-name').value = user.ho_ten || '';
        document.getElementById('profile-phone').value = user.so_dt || '';
        document.getElementById('profile-email').value = user.email || '';
        document.getElementById('profile-address').value = user.dia_chi || '';
        
        // Avatar trong form
        const avatarImg = document.getElementById('profile-avatar-img');
        const avatarText = document.getElementById('profile-avatar-text');
        
        if (user.avt) {
          if (avatarImg) {
            avatarImg.src = user.avt;
            avatarImg.classList.remove('hidden');
          }
          if (avatarText) avatarText.classList.add('hidden');
        } else {
          const initials = (user.ho_ten || 'U').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
          if (avatarText) {
            avatarText.textContent = initials;
            avatarText.classList.remove('hidden');
          }
          if (avatarImg) avatarImg.classList.add('hidden');
        }
        
        // Gi·ªõi t√≠nh
        if (user.gioi_tinh) {
          const genderRadio = document.querySelector(`input[name="gender"][value="${user.gioi_tinh}"]`);
          if (genderRadio) genderRadio.checked = true;
        }
        
        // Ng√†y sinh
        if (user.ngay_sinh) {
          document.getElementById('profile-birthday').value = user.ngay_sinh;
        }
      }

      // H√†m c≈© ƒë·ªÉ t∆∞∆°ng th√≠ch
      function loadUserProfile() {
        loadUserProfileView();
      }

      // C·∫≠p nh·∫≠t th√¥ng tin user
      async function handleUpdateProfile(event) {
        event.preventDefault();
        
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user) return;

        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ƒêang c·∫≠p nh·∫≠t...';
        
        try {
          // T·∫°o FormData ƒë·ªÉ g·ª≠i c·∫£ file avatar n·∫øu c√≥
          const formData = new FormData();
          formData.append('ho_ten', document.getElementById('profile-name').value.trim());
          formData.append('so_dt', document.getElementById('profile-phone').value.trim());
          formData.append('dia_chi', document.getElementById('profile-address').value.trim());
          
          // Th√™m gi·ªõi t√≠nh
          const selectedGender = document.querySelector('input[name="gender"]:checked');
          if (selectedGender) {
            formData.append('gioi_tinh', selectedGender.value);
          }
          
          // Th√™m ng√†y sinh
          const birthdayValue = document.getElementById('profile-birthday').value;
          if (birthdayValue) {
            formData.append('ngay_sinh', birthdayValue);
          }
          
          // N·∫øu c√≥ ch·ªçn avatar m·ªõi
          const avatarInput = document.getElementById('profile-avatar');
          if (avatarInput && avatarInput.files[0]) {
            formData.append('avt', avatarInput.files[0]);
          }

          const response = await fetch(`${API_URL}/auth/profile/${user.ma_kh}`, {
            method: 'PUT',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            // C·∫≠p nh·∫≠t localStorage v·ªõi d·ªØ li·ªáu m·ªõi t·ª´ server
            localStorage.setItem('user', JSON.stringify(data.data));
            
            alert('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!');
            
            // Reload sidebar v√† quay v·ªÅ View Mode
            loadSidebarUser();
            toggleEditMode(false);
          } else {
            alert(data.message || 'C·∫≠p nh·∫≠t th·∫•t b·∫°i!');
          }
        } catch (error) {
          console.error('L·ªói:', error);
          alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      }

      // Load profile khi trang load xong
      document.addEventListener('DOMContentLoaded', function() {
        // ƒê·ª£i sidebar load xong r·ªìi m·ªõi load user profile
        setTimeout(function() {
          loadUserProfile();
          loadMyOrders();
          loadMyAddresses();
          
          // X·ª≠ l√Ω scroll ƒë·∫øn section khi c√≥ hash
          handleHashNavigation();
        }, 300);
      });
      
      // X·ª≠ l√Ω navigation theo hash
      function handleHashNavigation() {
        const hash = window.location.hash;
        if (hash) {
          const targetElement = document.querySelector(hash);
          if (targetElement) {
            // Scroll ƒë·∫øn element
            setTimeout(() => {
              targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
            
            // Highlight sidebar link t∆∞∆°ng ·ª©ng
            updateSidebarActive(hash.replace('#', ''));
          }
        }
      }
      
      // C·∫≠p nh·∫≠t sidebar active state
      function updateSidebarActive(page) {
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        sidebarLinks.forEach(link => {
          link.classList.remove('bg-red-50', 'text-red-600', 'font-semibold');
          link.classList.add('text-gray-700');
          
          if (link.dataset.page === page) {
            link.classList.add('bg-red-50', 'text-red-600', 'font-semibold');
            link.classList.remove('text-gray-700');
          }
        });
      }
      
      // L·∫Øng nghe thay ƒë·ªïi hash
      window.addEventListener('hashchange', handleHashNavigation);

      // ===== ORDERS FUNCTIONS =====
      
      // Format gi√° ti·ªÅn
      function formatPrice(price) {
        return new Intl.NumberFormat('vi-VN').format(price) + 'ƒë';
      }
      
      // Format ng√†y
      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('vi-VN', {
          day: '2-digit',
          month: '2-digit', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
      
      // L·∫•y class v√† text cho tr·∫°ng th√°i
      function getStatusInfo(status) {
        const statusMap = {
          'pending': { class: 'bg-yellow-100 text-yellow-600', text: 'Ch·ªù x·ª≠ l√Ω', description: 'ƒêang ch·ªù admin x√°c nh·∫≠n - C√≥ th·ªÉ h·ªßy ƒë∆°n' },
          'pending_payment': { class: 'bg-orange-100 text-orange-600', text: 'Ch·ªù thanh to√°n', description: 'ƒêang ch·ªù thanh to√°n' },
          'confirmed': { class: 'bg-blue-100 text-blue-600', text: 'ƒê√£ x√°c nh·∫≠n', description: 'Admin ƒë√£ x√°c nh·∫≠n ƒë∆°n h√†ng' },
          'paid': { class: 'bg-green-100 text-green-600', text: 'ƒê√£ thanh to√°n', description: 'ƒê√£ thanh to√°n th√†nh c√¥ng' },
          'shipping': { class: 'bg-purple-100 text-purple-600', text: 'ƒêang giao', description: 'ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c giao' },
          'delivered': { class: 'bg-teal-100 text-teal-600', text: 'ƒê√£ giao', description: 'ƒê√£ giao h√†ng th√†nh c√¥ng' },
          'completed': { class: 'bg-green-100 text-green-600', text: 'Ho√†n th√†nh', description: 'ƒê∆°n h√†ng ƒë√£ ho√†n th√†nh' },
          'cancelled': { class: 'bg-gray-100 text-gray-600', text: 'ƒê√£ h·ªßy', description: 'ƒê∆°n h√†ng ƒë√£ b·ªã h·ªßy' }
        };
        return statusMap[status] || { class: 'bg-gray-100 text-gray-600', text: status, description: status };
      }
      
      // L·∫•y key ƒë∆°n h√†ng theo user
      function getOrdersKey() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (user && user.ma_kh) {
          return `orders_user_${user.ma_kh}`;
        }
        return 'orders_guest';
      }
      
      // Load ƒë∆°n h√†ng
      async function loadMyOrders() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        const ordersList = document.getElementById('orders-list');
        const ordersLoading = document.getElementById('orders-loading');
        const ordersEmpty = document.getElementById('orders-empty');
        const ordersCount = document.getElementById('orders-count');
        
        if (!user) return;
        
        let allOrders = [];
        
        // 1. L·∫•y ƒë∆°n h√†ng t·ª´ localStorage theo user
        const ordersKey = getOrdersKey();
        const localOrders = JSON.parse(localStorage.getItem(ordersKey) || '[]');
        
        console.log('=== DEBUG loadMyOrders ===');
        console.log('Local orders:', localOrders.map(o => ({id: o.orderId, status: o.status})));
        
        allOrders = [...localOrders];
        
        // 2. Th·ª≠ l·∫•y t·ª´ database (c√≥ k√®m chi ti·∫øt s·∫£n ph·∫©m)
        try {
          const response = await fetch(`${API_URL}/orders/user/${user.ma_kh}`);
          const data = await response.json();
          if (data.success && data.data.length > 0) {
            // Merge v·ªõi local orders
            data.data.forEach(dbOrder => {
              // T√¨m trong allOrders xem c√≥ ƒë∆°n tr√πng dbOrderId kh√¥ng
              const existIndex = allOrders.findIndex(o => o.dbOrderId === dbOrder.ma_don);
              
              if (existIndex >= 0) {
                // ƒê√É T·ªíN T·∫†I: Update status t·ª´ DB (DB l√† ngu·ªìn ch√≠nh x√°c nh·∫•t)
                allOrders[existIndex].status = dbOrder.trang_thai;
                allOrders[existIndex].items = dbOrder.items || allOrders[existIndex].items;
              } else {
                // CH∆ØA T·ªíN T·∫†I: Th√™m m·ªõi t·ª´ DB
                allOrders.push({
                  orderId: `#${dbOrder.ma_don}`,
                  dbOrderId: dbOrder.ma_don,
                  orderDate: dbOrder.thoi_gian,
                  status: dbOrder.trang_thai,
                  customer: { fullName: dbOrder.ten_nguoi_nhan, phone: dbOrder.so_dt },
                  address: { detail: dbOrder.dia_chi_nhan },
                  pricing: { 
                    total: parseFloat(dbOrder.tong_tien),
                    shippingFee: 0,
                    discount: 0
                  },
                  payment: { method: dbOrder.phuong_thuc || 'cod' },
                  items: dbOrder.items || [] // Chi ti·∫øt s·∫£n ph·∫©m t·ª´ API
                });
              }
            });
          }
        } catch (error) {
          console.log('Kh√¥ng th·ªÉ load t·ª´ DB:', error);
        }
        
        // S·∫Øp x·∫øp theo ng√†y m·ªõi nh·∫•t
        allOrders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));
        
        // L∆∞u v√†o bi·∫øn global ƒë·ªÉ viewOrderDetail c√≥ th·ªÉ truy c·∫≠p
        allLoadedOrders = allOrders;
        
        // ·∫®n loading
        if (ordersLoading) ordersLoading.classList.add('hidden');
        
        // Hi·ªÉn th·ªã
        if (allOrders.length === 0) {
          ordersEmpty.classList.remove('hidden');
          ordersCount.textContent = '0 ƒë∆°n h√†ng';
          return;
        }
        
        ordersCount.textContent = `${allOrders.length} ƒë∆°n h√†ng`;
        ordersEmpty.classList.add('hidden');
        
        // Render ƒë∆°n h√†ng
        ordersList.innerHTML = allOrders.map(order => {
          const statusInfo = getStatusInfo(order.status);
          const items = order.items || [];
          const firstItem = items[0];
          const moreItems = items.length > 1 ? items.length - 1 : 0;
          const canCancel = order.status === 'pending'; // Ch·ªâ cho ph√©p h·ªßy khi pending (ch·ªù x·ª≠ l√Ω)
          
          return `
            <div class="border rounded-lg p-4 hover:shadow-md transition">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <span class="text-gray-600 text-sm font-medium">M√£ ƒë∆°n: ${order.orderId}</span>
                  <p class="text-sm text-gray-500">${formatDate(order.orderDate)}</p>
                </div>
                <div class="text-right">
                  <span class="${statusInfo.class} px-3 py-1 rounded-full text-sm font-semibold">${statusInfo.text}</span>
                  ${canCancel ? '<p class="text-xs text-yellow-600 mt-1"><i class="fas fa-info-circle mr-1"></i>C√≥ th·ªÉ h·ªßy</p>' : ''}
                </div>
              </div>

              ${firstItem ? `
              <div class="flex items-center space-x-4 mb-3">
                <img src="${firstItem.image || 'images/iphone.jpg'}" alt="${firstItem.name}" class="w-16 h-16 object-contain rounded border" onerror="this.src='images/iphone.jpg'">
                <div class="flex-1 min-w-0">
                  <h3 class="font-semibold text-gray-800 truncate">${firstItem.name}</h3>
                  <p class="text-sm text-gray-600">${firstItem.color || ''} ${firstItem.storage || ''}</p>
                  <p class="text-sm text-gray-500">x${firstItem.quantity}</p>
                </div>
                <div class="text-right">
                  <p class="font-bold text-red-600">${formatPrice(firstItem.price * firstItem.quantity)}</p>
                  ${(order.status === 'delivered' || order.status === 'completed' || order.status === 'da_giao' || order.status === 'hoan_thanh' || order.status === 'confirmed' || order.status === 'paid') ? `
                    <button onclick="openReviewModal(${firstItem.id}, '${firstItem.name.replace(/'/g, "\\'")}', '${firstItem.image || 'images/iphone.jpg'}', '${(firstItem.color || '') + ' ' + (firstItem.storage || '')}')" 
                      class="mt-1 text-xs text-yellow-600 hover:text-yellow-700 font-semibold">
                      <i class="fas fa-star mr-1"></i>ƒê√°nh gi√°
                    </button>
                  ` : ''}
                </div>
              </div>
              ${moreItems > 0 ? `<p class="text-sm text-gray-500 mb-3">+ ${moreItems} s·∫£n ph·∫©m kh√°c</p>` : ''}
              ` : `
              <div class="text-center py-4 text-gray-500 text-sm">
                <i class="fas fa-box mr-2"></i>ƒê∆°n h√†ng t·ª´ h·ªá th·ªëng
              </div>
              `}

              <div class="flex items-center justify-between pt-3 border-t">
                <div class="text-sm text-gray-600">
                  T·ªïng: <span class="font-bold text-lg text-red-600">${formatPrice(order.pricing?.total || 0)}</span>
                </div>
                <div class="flex gap-2">
                  ${order.status === 'completed' || order.status === 'paid' || order.status === 'delivered' ? `
                    <button onclick="reorder('${order.orderId}')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition text-sm">
                      <i class="fas fa-redo mr-1"></i>Mua l·∫°i
                    </button>
                  ` : ''}
                  ${canCancel ? `
                    <button onclick="cancelOrder('${order.orderId}')" class="border border-red-500 text-red-500 px-4 py-2 rounded-lg font-semibold hover:bg-red-50 transition text-sm">
                      <i class="fas fa-times mr-1"></i>H·ªßy ƒë∆°n
                    </button>
                  ` : ''}
                  <button onclick="viewOrderDetail('${order.orderId}')" class="border border-red-600 text-red-600 px-4 py-2 rounded-lg font-semibold hover:bg-red-50 transition text-sm">
                    Chi ti·∫øt
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      // Bi·∫øn l∆∞u order ƒëang xem v√† danh s√°ch t·∫•t c·∫£ orders
      let currentViewOrder = null;
      let allLoadedOrders = [];
      
      // Xem chi ti·∫øt ƒë∆°n h√†ng
      function viewOrderDetail(orderId) {
        // T√¨m trong danh s√°ch ƒë√£ load (bao g·ªìm c·∫£ t·ª´ DB)
        const order = allLoadedOrders.find(o => o.orderId === orderId);
        
        if (!order) {
          console.log('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng:', orderId);
          return;
        }
        
        currentViewOrder = order;
        const statusInfo = getStatusInfo(order.status);
        const paymentLabels = {
          'cod': 'Thanh to√°n khi nh·∫≠n h√†ng',
          'momo_qr': 'MoMo - QR Code',
          'momo_wallet': 'MoMo - V√≠ ƒëi·ªán t·ª≠',
          'momo_atm': 'MoMo - Th·∫ª ATM',
          'momo_credit': 'MoMo - Th·∫ª qu·ªëc t·∫ø'
        };
        
        // C·∫≠p nh·∫≠t modal
        document.getElementById('modalOrderId').textContent = order.orderId;
        document.getElementById('modalStatus').textContent = statusInfo.text;
        document.getElementById('modalStatus').className = `${statusInfo.class} px-3 py-1 rounded-full text-sm font-semibold`;
        
        // Customer info
        document.getElementById('modalCustomer').textContent = order.customer?.fullName || '---';
        document.getElementById('modalPhone').textContent = order.customer?.phone || '---';
        document.getElementById('modalAddress').textContent = order.address?.detail || '---';
        
        // Payment info
        document.getElementById('modalPayment').textContent = paymentLabels[order.payment?.method] || order.payment?.method || 'COD';
        document.getElementById('modalShipping').textContent = order.pricing?.shippingFee ? formatPrice(order.pricing.shippingFee) : 'Mi·ªÖn ph√≠';
        document.getElementById('modalDiscount').textContent = order.pricing?.discount ? '-' + formatPrice(order.pricing.discount) : '0ƒë';
        document.getElementById('modalTotal').textContent = formatPrice(order.pricing?.total || 0);
        
        // Products
        const productsContainer = document.getElementById('modalProducts');
        const items = order.items || [];
        
        const canReview = order.status === 'delivered' || order.status === 'completed' || order.status === 'da_giao' || order.status === 'hoan_thanh' || order.status === 'confirmed' || order.status === 'paid';
        
        if (items.length > 0) {
          productsContainer.innerHTML = items.map(item => `
            <div class="flex items-center gap-3 p-3 bg-white rounded-lg border">
              <img src="${item.image || 'images/iphone.jpg'}" alt="${item.name}" 
                class="w-16 h-16 object-contain rounded border" onerror="this.src='images/iphone.jpg'">
              <div class="flex-1 min-w-0">
                <h5 class="font-semibold text-gray-800 text-sm truncate">${item.name}</h5>
                <p class="text-xs text-gray-500">${item.color || ''} ${item.storage || ''}</p>
                <p class="text-xs text-gray-500">S·ªë l∆∞·ª£ng: ${item.quantity}</p>
              </div>
              <div class="text-right">
                <p class="font-bold text-red-600 text-sm">${formatPrice(item.price)}</p>
                <p class="text-xs text-gray-500">x${item.quantity}</p>
                ${canReview ? `
                  <button onclick="openReviewModal(${item.id}, '${item.name.replace(/'/g, "\\'")}', '${item.image || 'images/iphone.jpg'}', '${(item.color || '') + ' ' + (item.storage || '')}')" 
                    class="mt-1 text-xs bg-yellow-100 text-yellow-700 hover:bg-yellow-200 px-2 py-1 rounded font-semibold transition">
                    <i class="fas fa-star mr-1"></i>ƒê√°nh gi√°
                  </button>
                ` : ''}
              </div>
            </div>
          `).join('');
        } else {
          productsContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Kh√¥ng c√≥ th√¥ng tin s·∫£n ph·∫©m</p>';
        }
        
        // Show/hide reorder button
        const reorderBtn = document.getElementById('modalReorderBtn');
        if (order.status === 'completed' || order.status === 'paid' || order.status === 'confirmed') {
          reorderBtn.classList.remove('hidden');
        } else {
          reorderBtn.classList.add('hidden');
        }
        
        // Show modal
        document.getElementById('orderDetailModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }
      
      // ƒê√≥ng modal
      function closeOrderModal() {
        document.getElementById('orderDetailModal').classList.add('hidden');
        document.body.style.overflow = '';
        currentViewOrder = null;
      }
      
      // Mua l·∫°i t·ª´ modal
      function reorderFromModal() {
        if (currentViewOrder) {
          reorder(currentViewOrder.orderId);
          closeOrderModal();
        }
      }
      
      // Mua l·∫°i
      function reorder(orderId) {
        const order = allLoadedOrders.find(o => o.orderId === orderId);
        
        if (order && order.items) {
          const user = JSON.parse(localStorage.getItem('user') || 'null');
          const cartKey = user?.ma_kh ? `cart_user_${user.ma_kh}` : 'cart_guest';
          
          // Th√™m items v√†o gi·ªè h√†ng
          let cart = JSON.parse(localStorage.getItem(cartKey) || '[]');
          order.items.forEach(item => {
            const existing = cart.find(c => c.id === item.id);
            if (existing) {
              existing.quantity += item.quantity;
            } else {
              cart.push({...item});
            }
          });
          localStorage.setItem(cartKey, JSON.stringify(cart));
          
          alert('ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!');
          window.location.href = 'cart.html';
        }
      }
      
      // ===== CANCEL ORDER FUNCTIONS =====
      let cancelOrderData = null;
      
      // M·ªü modal h·ªßy ƒë∆°n h√†ng
      function cancelOrder(orderId) {
        // T√¨m ƒë∆°n h√†ng ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i
        const order = allLoadedOrders.find(o => o.orderId === orderId);
        
        if (!order) {
          alert('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng!');
          return;
        }
        
        // Ki·ªÉm tra tr·∫°ng th√°i - ch·ªâ cho ph√©p h·ªßy khi pending
        if (order.status !== 'pending') {
          const statusLabels = {
            'confirmed': 'ƒë√£ ƒë∆∞·ª£c admin x√°c nh·∫≠n',
            'shipping': 'ƒëang giao h√†ng',
            'delivered': 'ƒë√£ giao h√†ng',
            'completed': 'ƒë√£ ho√†n th√†nh',
            'cancelled': 'ƒë√£ b·ªã h·ªßy'
          };
          const statusText = statusLabels[order.status] || order.status;
          alert(`Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng ${statusText}!\n\nCh·ªâ c√≥ th·ªÉ h·ªßy ƒë∆°n h√†ng ƒëang ch·ªù x·ª≠ l√Ω (ch∆∞a ƒë∆∞·ª£c admin x√°c nh·∫≠n).`);
          return;
        }
        
        // L∆∞u th√¥ng tin ƒë∆°n h√†ng c·∫ßn h·ªßy
        cancelOrderData = order;
        
        // Hi·ªÉn th·ªã modal
        document.getElementById('cancelOrderId').textContent = order.orderId;
        document.getElementById('cancelReasonSelect').value = '';
        document.getElementById('cancelReasonText').value = '';
        document.getElementById('cancelReasonText').classList.add('hidden');
        document.getElementById('cancelOrderModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }
      
      // ƒê√≥ng modal h·ªßy ƒë∆°n
      function closeCancelModal() {
        document.getElementById('cancelOrderModal').classList.add('hidden');
        document.body.style.overflow = '';
        cancelOrderData = null;
      }
      
      // X·ª≠ l√Ω khi ch·ªçn l√Ω do
      function handleCancelReasonChange(selectEl) {
        const textEl = document.getElementById('cancelReasonText');
        if (selectEl.value === 'other') {
          textEl.classList.remove('hidden');
          textEl.focus();
        } else {
          textEl.classList.add('hidden');
        }
      }
      
      // X√°c nh·∫≠n h·ªßy ƒë∆°n h√†ng
      async function confirmCancelOrder() {
        if (!cancelOrderData) return;
        
        const selectVal = document.getElementById('cancelReasonSelect').value;
        const textVal = document.getElementById('cancelReasonText').value.trim();
        
        // L·∫•y l√Ω do h·ªßy
        let cancelReason = '';
        if (selectVal === 'other') {
          cancelReason = textVal;
        } else {
          cancelReason = selectVal;
        }
        
        if (!cancelReason) {
          alert('Vui l√≤ng ch·ªçn ho·∫∑c nh·∫≠p l√Ω do h·ªßy ƒë∆°n h√†ng!');
          return;
        }
        
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        
        // N·∫øu ƒë∆°n h√†ng c√≥ dbOrderId (t·ª´ database), g·ªçi API ƒë·ªÉ h·ªßy
        if (cancelOrderData.dbOrderId) {
          try {
            const response = await fetch(`${API_URL}/orders/${cancelOrderData.dbOrderId}/cancel`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                userId: user?.ma_kh,
                cancelReason: cancelReason
              })
            });
            
            const data = await response.json();
            
            if (data.success) {
              closeCancelModal();
              alert('ƒê√£ h·ªßy ƒë∆°n h√†ng th√†nh c√¥ng!');
              loadMyOrders(); // Reload danh s√°ch
            } else {
              alert(data.message || 'Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng!');
            }
          } catch (error) {
            console.error('Error cancelling order:', error);
            alert('C√≥ l·ªói x·∫£y ra khi h·ªßy ƒë∆°n h√†ng!');
          }
        } else {
          // ƒê∆°n h√†ng ch·ªâ c√≥ trong localStorage
          const ordersKey = getOrdersKey();
          const orders = JSON.parse(localStorage.getItem(ordersKey) || '[]');
          
          console.log('Cancel localStorage order:', cancelOrderData.orderId);
          console.log('Orders in localStorage:', orders.map(o => o.orderId));
          
          const orderIndex = orders.findIndex(o => o.orderId === cancelOrderData.orderId);
          
          console.log('Found at index:', orderIndex);
          
          if (orderIndex >= 0) {
            orders[orderIndex].status = 'cancelled';
            orders[orderIndex].cancelReason = cancelReason;
            localStorage.setItem(ordersKey, JSON.stringify(orders));
            closeCancelModal();
            alert('ƒê√£ h·ªßy ƒë∆°n h√†ng th√†nh c√¥ng!');
            loadMyOrders();
          } else {
            // Th·ª≠ t√¨m theo c√°ch kh√°c - c√≥ th·ªÉ orderId c√≥ # ho·∫∑c kh√¥ng
            const orderIdWithoutHash = cancelOrderData.orderId.replace('#', '');
            const orderIndex2 = orders.findIndex(o => 
              o.orderId === cancelOrderData.orderId || 
              o.orderId === orderIdWithoutHash ||
              o.orderId === '#' + orderIdWithoutHash
            );
            
            if (orderIndex2 >= 0) {
              orders[orderIndex2].status = 'cancelled';
              orders[orderIndex2].cancelReason = cancelReason;
              localStorage.setItem(ordersKey, JSON.stringify(orders));
              closeCancelModal();
              alert('ƒê√£ h·ªßy ƒë∆°n h√†ng th√†nh c√¥ng!');
              loadMyOrders();
            } else {
              alert('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng trong h·ªá th·ªëng!');
            }
          }
        }
      }
      
      // ===== ADDRESS FUNCTIONS (Multi-address like Shopee) =====
      let addressProvincesData = [];
      let addressDistrictsData = [];
      let addressWardsData = [];
      let currentEditAddressId = null;
      
      // Load danh s√°ch ƒë·ªãa ch·ªâ t·ª´ API
      async function loadMyAddresses() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        const addressList = document.getElementById('address-list');
        const addressLoading = document.getElementById('address-loading');
        const addressEmpty = document.getElementById('address-empty');
        
        if (!user || !user.ma_kh) return;
        
        try {
          const response = await fetch(`${API_URL}/address/${user.ma_kh}`);
          const data = await response.json();
          
          // ·∫®n loading
          if (addressLoading) addressLoading.classList.add('hidden');
          
          if (data.success && data.data.length > 0) {
            if (addressEmpty) addressEmpty.classList.add('hidden');
            renderAddressList(data.data);
          } else {
            if (addressList) addressList.innerHTML = '';
            if (addressEmpty) addressEmpty.classList.remove('hidden');
          }
        } catch (error) {
          console.error('Error loading addresses:', error);
          if (addressLoading) addressLoading.classList.add('hidden');
          if (addressEmpty) addressEmpty.classList.remove('hidden');
        }
      }
      
      // Render danh s√°ch ƒë·ªãa ch·ªâ
      function renderAddressList(addresses) {
        const addressList = document.getElementById('address-list');
        if (!addressList) return;
        
        addressList.innerHTML = addresses.map(addr => `
          <div class="border rounded-lg p-4 hover:shadow-md transition ${addr.mac_dinh ? 'border-red-500 bg-red-50' : 'bg-gray-50'}">
            <div class="flex items-start justify-between">
              <div class="flex items-start gap-3 flex-1">
                <i class="fas fa-map-marker-alt text-red-600 mt-1 text-lg"></i>
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1 flex-wrap">
                    <span class="font-semibold text-gray-800">${addr.ho_ten_nguoi_nhan}</span>
                    <span class="text-gray-400">|</span>
                    <span class="text-gray-600">${addr.so_dien_thoai}</span>
                    ${addr.mac_dinh ? '<span class="bg-red-600 text-white text-xs px-2 py-0.5 rounded">M·∫∑c ƒë·ªãnh</span>' : ''}
                    <span class="text-xs px-2 py-0.5 rounded ${addr.loai_dia_chi === 'co_quan' ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600'}">
                      <i class="fas fa-${addr.loai_dia_chi === 'co_quan' ? 'building' : 'home'} mr-1"></i>${addr.loai_dia_chi === 'co_quan' ? 'C∆° quan' : 'Nh√† ri√™ng'}
                    </span>
                  </div>
                  <p class="text-gray-600 text-sm">${addr.dia_chi_cu_the}</p>
                  <p class="text-gray-500 text-sm">${addr.phuong_xa}, ${addr.quan_huyen}, ${addr.tinh_thanh}</p>
                </div>
              </div>
              <div class="flex items-center gap-2 ml-4">
                <button onclick="editAddress(${addr.ma_dia_chi})" class="text-blue-600 hover:text-blue-700 text-sm font-semibold">
                  <i class="fas fa-edit mr-1"></i>S·ª≠a
                </button>
                ${!addr.mac_dinh ? `
                  <button onclick="deleteAddress(${addr.ma_dia_chi})" class="text-red-600 hover:text-red-700 text-sm font-semibold">
                    <i class="fas fa-trash mr-1"></i>X√≥a
                  </button>
                  <button onclick="setDefaultAddress(${addr.ma_dia_chi})" class="text-green-600 hover:text-green-700 text-sm font-semibold">
                    <i class="fas fa-check mr-1"></i>ƒê·∫∑t m·∫∑c ƒë·ªãnh
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `).join('');
      }
      
      // M·ªü modal th√™m ƒë·ªãa ch·ªâ
      function openAddAddressModal() {
        currentEditAddressId = null;
        document.getElementById('addressModalTitle').textContent = 'Th√™m ƒë·ªãa ch·ªâ m·ªõi';
        document.getElementById('addressForm').reset();
        document.getElementById('addressId').value = '';
        document.getElementById('addressModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        // Load provinces
        loadAddressProvinces();
      }
      
      // ƒê√≥ng modal ƒë·ªãa ch·ªâ
      function closeAddressModal() {
        document.getElementById('addressModal').classList.add('hidden');
        document.body.style.overflow = '';
        currentEditAddressId = null;
      }
      
      // Load danh s√°ch t·ªânh/th√†nh
      async function loadAddressProvinces() {
        try {
          const response = await fetch('https://provinces.open-api.vn/api/p/');
          addressProvincesData = await response.json();
          
          const select = document.getElementById('addr-province');
          select.innerHTML = '<option value="">Ch·ªçn T·ªânh/TP</option>' + 
            addressProvincesData.map(p => `<option value="${p.name}" data-code="${p.code}">${p.name}</option>`).join('');
        } catch (error) {
          console.error('Error loading provinces:', error);
        }
      }
      
      // Load qu·∫≠n/huy·ªán
      async function loadAddressDistricts() {
        const provinceSelect = document.getElementById('addr-province');
        const selectedOption = provinceSelect.options[provinceSelect.selectedIndex];
        const provinceCode = selectedOption?.dataset?.code;
        
        const districtSelect = document.getElementById('addr-district');
        const wardSelect = document.getElementById('addr-ward');
        
        districtSelect.innerHTML = '<option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>';
        wardSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';
        
        if (!provinceCode) return;
        
        try {
          const response = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
          const data = await response.json();
          addressDistrictsData = data.districts || [];
          
          districtSelect.innerHTML = '<option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>' + 
            addressDistrictsData.map(d => `<option value="${d.name}" data-code="${d.code}">${d.name}</option>`).join('');
        } catch (error) {
          console.error('Error loading districts:', error);
        }
      }
      
      // Load ph∆∞·ªùng/x√£
      async function loadAddressWards() {
        const districtSelect = document.getElementById('addr-district');
        const selectedOption = districtSelect.options[districtSelect.selectedIndex];
        const districtCode = selectedOption?.dataset?.code;
        
        const wardSelect = document.getElementById('addr-ward');
        wardSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';
        
        if (!districtCode) return;
        
        try {
          const response = await fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`);
          const data = await response.json();
          addressWardsData = data.wards || [];
          
          wardSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>' + 
            addressWardsData.map(w => `<option value="${w.name}">${w.name}</option>`).join('');
        } catch (error) {
          console.error('Error loading wards:', error);
        }
      }
      
      // L∆∞u ƒë·ªãa ch·ªâ (th√™m m·ªõi ho·∫∑c c·∫≠p nh·∫≠t)
      async function saveAddress() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user || !user.ma_kh) {
          alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
          return;
        }
        
        const fullname = document.getElementById('addr-fullname').value.trim();
        const phone = document.getElementById('addr-phone').value.trim();
        const province = document.getElementById('addr-province').value;
        const district = document.getElementById('addr-district').value;
        const ward = document.getElementById('addr-ward').value;
        const detail = document.getElementById('addr-detail').value.trim();
        const addrType = document.querySelector('input[name="addr-type"]:checked')?.value || 'nha_rieng';
        const isDefault = document.getElementById('addr-default').checked;
        
        // Validate
        if (!fullname) { alert('Vui l√≤ng nh·∫≠p h·ªç t√™n ng∆∞·ªùi nh·∫≠n!'); return; }
        if (!phone) { alert('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!'); return; }
        if (!province) { alert('Vui l√≤ng ch·ªçn T·ªânh/TP!'); return; }
        if (!district) { alert('Vui l√≤ng ch·ªçn Qu·∫≠n/Huy·ªán!'); return; }
        if (!ward) { alert('Vui l√≤ng ch·ªçn Ph∆∞·ªùng/X√£!'); return; }
        if (!detail) { alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ c·ª• th·ªÉ!'); return; }
        
        const phoneRegex = /^(0|\+84)[0-9]{9}$/;
        if (!phoneRegex.test(phone.replace(/\s/g, ''))) {
          alert('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá!');
          return;
        }
        
        const addressData = {
          ma_kh: user.ma_kh,
          ho_ten_nguoi_nhan: fullname,
          so_dien_thoai: phone,
          tinh_thanh: province,
          quan_huyen: district,
          phuong_xa: ward,
          dia_chi_cu_the: detail,
          loai_dia_chi: addrType,
          mac_dinh: isDefault ? 1 : 0
        };
        
        try {
          let response;
          if (currentEditAddressId) {
            // C·∫≠p nh·∫≠t
            response = await fetch(`${API_URL}/address/${currentEditAddressId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(addressData)
            });
          } else {
            // Th√™m m·ªõi
            response = await fetch(`${API_URL}/address`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(addressData)
            });
          }
          
          const data = await response.json();
          
          if (data.success) {
            alert(currentEditAddressId ? 'C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ th√†nh c√¥ng!' : 'Th√™m ƒë·ªãa ch·ªâ th√†nh c√¥ng!');
            closeAddressModal();
            loadMyAddresses();
          } else {
            alert(data.message || 'C√≥ l·ªói x·∫£y ra!');
          }
        } catch (error) {
          console.error('Error saving address:', error);
          alert('C√≥ l·ªói x·∫£y ra khi l∆∞u ƒë·ªãa ch·ªâ!');
        }
      }
      
      // S·ª≠a ƒë·ªãa ch·ªâ
      async function editAddress(addressId) {
        try {
          const user = JSON.parse(localStorage.getItem('user') || 'null');
          const response = await fetch(`${API_URL}/address/${user.ma_kh}`);
          const data = await response.json();
          
          if (data.success) {
            const address = data.data.find(a => a.ma_dia_chi === addressId);
            if (address) {
              currentEditAddressId = addressId;
              document.getElementById('addressModalTitle').textContent = 'Ch·ªânh s·ª≠a ƒë·ªãa ch·ªâ';
              document.getElementById('addressId').value = addressId;
              document.getElementById('addr-fullname').value = address.ho_ten_nguoi_nhan;
              document.getElementById('addr-phone').value = address.so_dien_thoai;
              document.getElementById('addr-detail').value = address.dia_chi_cu_the;
              document.getElementById('addr-default').checked = address.mac_dinh === 1;
              
              // Set lo·∫°i ƒë·ªãa ch·ªâ
              document.querySelector(`input[name="addr-type"][value="${address.loai_dia_chi}"]`).checked = true;
              
              // Load provinces v√† set gi√° tr·ªã
              await loadAddressProvinces();
              document.getElementById('addr-province').value = address.tinh_thanh;
              
              // Load districts v√† set gi√° tr·ªã
              await loadAddressDistricts();
              document.getElementById('addr-district').value = address.quan_huyen;
              
              // Load wards v√† set gi√° tr·ªã
              await loadAddressWards();
              document.getElementById('addr-ward').value = address.phuong_xa;
              
              document.getElementById('addressModal').classList.remove('hidden');
              document.body.style.overflow = 'hidden';
            }
          }
        } catch (error) {
          console.error('Error loading address for edit:', error);
          alert('C√≥ l·ªói x·∫£y ra!');
        }
      }
      
      // X√≥a ƒë·ªãa ch·ªâ
      async function deleteAddress(addressId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë·ªãa ch·ªâ n√†y?')) return;
        
        try {
          const response = await fetch(`${API_URL}/address/${addressId}`, {
            method: 'DELETE'
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('X√≥a ƒë·ªãa ch·ªâ th√†nh c√¥ng!');
            loadMyAddresses();
          } else {
            alert(data.message || 'C√≥ l·ªói x·∫£y ra!');
          }
        } catch (error) {
          console.error('Error deleting address:', error);
          alert('C√≥ l·ªói x·∫£y ra khi x√≥a ƒë·ªãa ch·ªâ!');
        }
      }
      
      // ƒê·∫∑t ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
      async function setDefaultAddress(addressId) {
        try {
          const response = await fetch(`${API_URL}/address/${addressId}/set-default`, {
            method: 'PUT'
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('ƒê√£ ƒë·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh!');
            loadMyAddresses();
          } else {
            alert(data.message || 'C√≥ l·ªói x·∫£y ra!');
          }
        } catch (error) {
          console.error('Error setting default address:', error);
          alert('C√≥ l·ªói x·∫£y ra!');
        }
      }
      
      // ===== REVIEW FUNCTIONS =====
      let currentReviewProduct = null;
      let selectedReviewRating = 0;
      let reviewImagesProfile = [];
      const ratingTexts = ['', 'R·∫•t t·ªá', 'T·ªá', 'B√¨nh th∆∞·ªùng', 'T·ªët', 'Tuy·ªát v·ªùi'];
      
      // M·ªü modal ƒë√°nh gi√°
      async function openReviewModal(productId, productName, productImage, productVariant) {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user || !user.ma_kh) {
          alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë√°nh gi√°!');
          return;
        }
        
        // Ki·ªÉm tra quy·ªÅn ƒë√°nh gi√°
        try {
          const response = await fetch(`${API_URL}/reviews/can-review/${productId}/${user.ma_kh}`);
          const data = await response.json();
          
          if (!data.canReview) {
            alert(data.message);
            return;
          }
        } catch (error) {
          console.error('L·ªói ki·ªÉm tra quy·ªÅn ƒë√°nh gi√°:', error);
        }
        
        currentReviewProduct = { id: productId, name: productName, image: productImage, variant: productVariant };
        
        // C·∫≠p nh·∫≠t th√¥ng tin s·∫£n ph·∫©m trong modal
        document.getElementById('reviewProductImage').src = productImage;
        document.getElementById('reviewProductImage').onerror = function() { this.src = 'images/iphone.jpg'; };
        document.getElementById('reviewProductName').textContent = productName;
        document.getElementById('reviewProductVariant').textContent = productVariant || '';
        
        // Reset form
        selectedReviewRating = 0;
        reviewImagesProfile = [];
        document.getElementById('reviewCommentInput').value = '';
        document.getElementById('reviewImagePreviewProfile').innerHTML = '';
        document.getElementById('ratingText').textContent = 'Ch·ªçn s·ªë sao';
        document.querySelectorAll('#reviewRatingInput i').forEach(star => {
          star.className = 'far fa-star';
          star.parentElement.classList.remove('text-yellow-400');
          star.parentElement.classList.add('text-gray-300');
        });
        
        // ƒê√≥ng modal chi ti·∫øt ƒë∆°n h√†ng n·∫øu ƒëang m·ªü
        closeOrderModal();
        
        // Hi·ªÉn th·ªã modal ƒë√°nh gi√°
        document.getElementById('reviewProductModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }
      
      // ƒê√≥ng modal ƒë√°nh gi√°
      function closeReviewModal() {
        document.getElementById('reviewProductModal').classList.add('hidden');
        document.body.style.overflow = '';
        currentReviewProduct = null;
      }
      
      // Ch·ªçn s·ªë sao
      function setReviewRating(rating) {
        selectedReviewRating = rating;
        document.getElementById('ratingText').textContent = ratingTexts[rating];
        
        document.querySelectorAll('#reviewRatingInput i').forEach((star, i) => {
          if (i < rating) {
            star.className = 'fas fa-star';
            star.parentElement.classList.add('text-yellow-400');
            star.parentElement.classList.remove('text-gray-300');
          } else {
            star.className = 'far fa-star';
            star.parentElement.classList.remove('text-yellow-400');
            star.parentElement.classList.add('text-gray-300');
          }
        });
      }
      
      // Preview ·∫£nh ƒë√°nh gi√°
      function previewReviewImagesProfile(input) {
        const files = input.files;
        const previewContainer = document.getElementById('reviewImagePreviewProfile');
        
        if (reviewImagesProfile.length + files.length > 5) {
          alert('Ch·ªâ ƒë∆∞·ª£c upload t·ªëi ƒëa 5 ·∫£nh!');
          return;
        }
        
        Array.from(files).forEach(file => {
          if (!file.type.startsWith('image/')) {
            alert('Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh!');
            return;
          }
          
          if (file.size > 5 * 1024 * 1024) {
            alert('·∫¢nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB!');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = (e) => {
            const base64 = e.target.result;
            reviewImagesProfile.push(base64);
            
            const imgWrapper = document.createElement('div');
            imgWrapper.className = 'relative';
            imgWrapper.innerHTML = `
              <img src="${base64}" alt="Preview" class="w-16 h-16 object-cover rounded-lg border" />
              <button type="button" onclick="removeReviewImageProfile(${reviewImagesProfile.length - 1}, this)" class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 transition">
                <i class="fas fa-times"></i>
              </button>
            `;
            previewContainer.appendChild(imgWrapper);
          };
          reader.readAsDataURL(file);
        });
        
        input.value = '';
      }
      
      // X√≥a ·∫£nh preview
      function removeReviewImageProfile(index, btn) {
        reviewImagesProfile.splice(index, 1);
        btn.parentElement.remove();
        
        const previewContainer = document.getElementById('reviewImagePreviewProfile');
        const buttons = previewContainer.querySelectorAll('button');
        buttons.forEach((b, i) => {
          b.setAttribute('onclick', `removeReviewImageProfile(${i}, this)`);
        });
      }
      
      // G·ª≠i ƒë√°nh gi√°
      async function submitProductReview() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user || !user.ma_kh) {
          alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë√°nh gi√°!');
          return;
        }
        
        if (!currentReviewProduct) {
          alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m!');
          return;
        }
        
        const comment = document.getElementById('reviewCommentInput').value.trim();
        
        if (selectedReviewRating === 0) {
          alert('Vui l√≤ng ch·ªçn s·ªë sao!');
          return;
        }
        
        if (!comment) {
          alert('Vui l√≤ng nh·∫≠p nh·∫≠n x√©t!');
          return;
        }
        
        try {
          const response = await fetch(`${API_URL}/reviews`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              productId: currentReviewProduct.id,
              userId: user.ma_kh,
              rating: selectedReviewRating,
              comment: comment,
              images: reviewImagesProfile
            })
          });
          
          const data = await response.json();
          
          if (response.ok) {
            alert('C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√° s·∫£n ph·∫©m!');
            closeReviewModal();
          } else {
            if (data.code === 'NOT_PURCHASED') {
              alert('B·∫°n c·∫ßn mua s·∫£n ph·∫©m n√†y tr∆∞·ªõc khi ƒë√°nh gi√°!');
            } else {
              alert(data.error || 'Kh√¥ng th·ªÉ g·ª≠i ƒë√°nh gi√°!');
            }
          }
        } catch (error) {
          console.error('L·ªói g·ª≠i ƒë√°nh gi√°:', error);
          alert('C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!');
        }
      }
    </script>

    <!-- AI Chatbot -->
    <link rel="stylesheet" href="components/ai-chatbot.css">
    <script src="components/ai-chatbot.js"></script>
  </body>
</html>


