<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Quên mật khẩu - QuangHưng Mobile</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
      * { font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
      
      body {
        position: relative;
        min-height: 100vh;
        overflow-x: hidden;
      }
      
      body::before {
        content: '';
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: linear-gradient(135deg, #e41e26 0%, #c5111a 100%);
        background-image: url('./images/cuahang.png');
        background-size: cover;
        background-position: center;
        z-index: -2;
      }
      
      body::after {
        content: '';
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: -1;
      }
      
      .glass-effect {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      }
      
      .step { display: none; }
      .step.active { display: block; }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
    </style>
  </head>
  <body class="flex items-center justify-center min-h-screen px-4 py-8">
    <div class="w-full max-w-md">

      <div class="glass-effect rounded-2xl p-8">
        <!-- Progress Steps -->
        <div class="flex items-center justify-center mb-8">
          <div class="flex items-center">
            <div id="step1-indicator" class="w-10 h-10 rounded-full bg-red-600 text-white flex items-center justify-center font-bold">1</div>
            <div id="line1" class="w-12 h-1 bg-gray-300"></div>
            <div id="step2-indicator" class="w-10 h-10 rounded-full bg-gray-300 text-gray-500 flex items-center justify-center font-bold">2</div>
            <div id="line2" class="w-12 h-1 bg-gray-300"></div>
            <div id="step3-indicator" class="w-10 h-10 rounded-full bg-gray-300 text-gray-500 flex items-center justify-center font-bold">3</div>
          </div>
        </div>

        <!-- Step 1: Nhập Email -->
        <div id="step1" class="step active animate-fadeIn">
          <div class="text-center mb-6">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-key text-3xl text-red-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">Quên mật khẩu?</h2>
            <p class="text-gray-600 mt-2">Nhập email để nhận mã xác thực</p>
          </div>

          <form onsubmit="handleSendResetOTP(event)" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email đăng ký</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                  <i class="fas fa-envelope text-gray-400"></i>
                </div>
                <input 
                  type="email" 
                  id="reset-email" 
                  placeholder="Nhập email của bạn" 
                  class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-xl outline-none focus:border-red-500 focus:ring-2 focus:ring-red-200 transition" 
                  required 
                />
              </div>
            </div>

            <button type="submit" id="send-otp-btn" class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white py-3 rounded-xl font-semibold hover:from-red-700 hover:to-red-800 transition shadow-lg">
              <i class="fas fa-paper-plane mr-2"></i>Gửi mã xác thực
            </button>
          </form>
        </div>

        <!-- Step 2: Nhập OTP -->
        <div id="step2" class="step animate-fadeIn">
          <div class="text-center mb-6">
            <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-shield-alt text-3xl text-blue-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">Xác thực OTP</h2>
            <p class="text-gray-600 mt-2">Nhập mã 6 số đã gửi đến</p>
            <p id="display-email" class="font-semibold text-red-600"></p>
          </div>

          <form onsubmit="handleVerifyResetOTP(event)" class="space-y-4">
            <div>
              <input 
                type="text" 
                id="reset-otp" 
                maxlength="6" 
                class="w-full px-4 py-4 border border-gray-300 rounded-xl text-center text-3xl font-bold tracking-widest outline-none focus:border-red-500 focus:ring-2 focus:ring-red-200 transition" 
                placeholder="000000"
                required
              />
            </div>

            <div class="text-center text-sm text-gray-500">
              <p>Không nhận được mã? 
                <button type="button" id="resend-btn" onclick="handleResendResetOTP()" class="text-red-600 hover:underline font-medium" disabled>
                  Gửi lại (<span id="countdown">60</span>s)
                </button>
              </p>
            </div>

            <div class="flex gap-3">
              <button type="button" onclick="goToStep(1)" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-200 transition">
                <i class="fas fa-arrow-left mr-2"></i>Quay lại
              </button>
              <button type="submit" id="verify-btn" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 transition">
                <i class="fas fa-check mr-2"></i>Xác thực
              </button>
            </div>
          </form>
        </div>


        <!-- Step 3: Đặt mật khẩu mới -->
        <div id="step3" class="step animate-fadeIn">
          <div class="text-center mb-6">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-lock text-3xl text-green-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">Đặt mật khẩu mới</h2>
            <p class="text-gray-600 mt-2">Tạo mật khẩu mới cho tài khoản</p>
          </div>

          <form onsubmit="handleResetPassword(event)" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Mật khẩu mới <span class="text-red-500">*</span></label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                  <i class="fas fa-lock text-gray-400"></i>
                </div>
                <input 
                  type="password" 
                  id="new-password" 
                  placeholder="Nhập mật khẩu mới (tối thiểu 8 ký tự)" 
                  class="w-full pl-12 pr-12 py-3 border border-gray-300 rounded-xl outline-none focus:border-red-500 focus:ring-2 focus:ring-red-200 transition" 
                  minlength="8"
                  required 
                />
                <button type="button" onclick="togglePassword('new-password', 'toggle1')" class="absolute inset-y-0 right-0 pr-4 flex items-center">
                  <i id="toggle1" class="fas fa-eye text-gray-400 hover:text-gray-600"></i>
                </button>
              </div>
              <!-- Password strength indicator -->
              <div id="password-strength" class="mt-2 hidden">
                <div class="flex gap-1">
                  <div id="str1" class="h-1 flex-1 rounded bg-gray-200"></div>
                  <div id="str2" class="h-1 flex-1 rounded bg-gray-200"></div>
                  <div id="str3" class="h-1 flex-1 rounded bg-gray-200"></div>
                  <div id="str4" class="h-1 flex-1 rounded bg-gray-200"></div>
                </div>
                <p id="strength-text" class="text-xs mt-1 text-gray-500"></p>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Xác nhận mật khẩu <span class="text-red-500">*</span></label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                  <i class="fas fa-lock text-gray-400"></i>
                </div>
                <input 
                  type="password" 
                  id="confirm-password" 
                  placeholder="Nhập lại mật khẩu mới" 
                  class="w-full pl-12 pr-12 py-3 border border-gray-300 rounded-xl outline-none focus:border-red-500 focus:ring-2 focus:ring-red-200 transition" 
                  required 
                />
                <button type="button" onclick="togglePassword('confirm-password', 'toggle2')" class="absolute inset-y-0 right-0 pr-4 flex items-center">
                  <i id="toggle2" class="fas fa-eye text-gray-400 hover:text-gray-600"></i>
                </button>
              </div>
              <p id="match-error" class="text-xs mt-1 text-red-500 hidden">Mật khẩu không khớp</p>
            </div>

            <button type="submit" id="reset-btn" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-xl font-semibold hover:from-green-700 hover:to-green-800 transition shadow-lg">
              <i class="fas fa-save mr-2"></i>Đặt lại mật khẩu
            </button>
          </form>
        </div>

        <!-- Back to Login -->
        <div class="mt-6 text-center">
          <a href="login.html" class="text-gray-600 hover:text-red-600 transition text-sm inline-flex items-center gap-2">
            <i class="fas fa-arrow-left"></i>
            <span>Quay lại đăng nhập</span>
          </a>
        </div>
      </div>

      <!-- Back to Home -->
      <div class="mt-6 text-center">
        <a href="index.html" class="text-white hover:text-white/80 transition text-sm inline-flex items-center gap-2">
          <i class="fas fa-home"></i>
          <span>Về trang chủ</span>
        </a>
      </div>
    </div>


    <script>
      const API_URL = 'http://localhost:3000/api';
      let resetEmail = '';
      let countdownTimer;

      // Chuyển step
      function goToStep(step) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById(`step${step}`).classList.add('active');
        
        // Update indicators
        for (let i = 1; i <= 3; i++) {
          const indicator = document.getElementById(`step${i}-indicator`);
          if (i < step) {
            indicator.className = 'w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold';
            indicator.innerHTML = '<i class="fas fa-check"></i>';
          } else if (i === step) {
            indicator.className = 'w-10 h-10 rounded-full bg-red-600 text-white flex items-center justify-center font-bold';
            indicator.textContent = i;
          } else {
            indicator.className = 'w-10 h-10 rounded-full bg-gray-300 text-gray-500 flex items-center justify-center font-bold';
            indicator.textContent = i;
          }
        }
        
        // Update lines
        document.getElementById('line1').className = step > 1 ? 'w-12 h-1 bg-green-500' : 'w-12 h-1 bg-gray-300';
        document.getElementById('line2').className = step > 2 ? 'w-12 h-1 bg-green-500' : 'w-12 h-1 bg-gray-300';
      }

      // Step 1: Gửi OTP
      async function handleSendResetOTP(event) {
        event.preventDefault();
        
        const email = document.getElementById('reset-email').value.trim();
        if (!email) {
          alert('Vui lòng nhập email!');
          return;
        }

        const btn = document.getElementById('send-otp-btn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang gửi...';

        try {
          const response = await fetch(`${API_URL}/auth/forgot-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });

          const data = await response.json();

          if (data.success) {
            resetEmail = email;
            document.getElementById('display-email').textContent = email;
            goToStep(2);
            startCountdown();
            document.getElementById('reset-otp').focus();
          } else {
            alert(data.message || 'Gửi OTP thất bại!');
          }
        } catch (error) {
          alert('Lỗi kết nối: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }

      // Step 2: Xác thực OTP
      async function handleVerifyResetOTP(event) {
        event.preventDefault();
        
        const otp = document.getElementById('reset-otp').value.trim();
        if (!otp || otp.length !== 6) {
          alert('Vui lòng nhập mã OTP 6 số!');
          return;
        }

        const btn = document.getElementById('verify-btn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang xác thực...';

        try {
          const response = await fetch(`${API_URL}/auth/verify-reset-otp`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: resetEmail, otp })
          });

          const data = await response.json();

          if (data.success) {
            if (countdownTimer) clearInterval(countdownTimer);
            goToStep(3);
            document.getElementById('new-password').focus();
          } else {
            alert(data.message || 'Mã OTP không đúng!');
          }
        } catch (error) {
          alert('Lỗi kết nối: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }

      // Step 3: Đặt mật khẩu mới
      async function handleResetPassword(event) {
        event.preventDefault();
        
        const mat_khau_moi = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        if (mat_khau_moi.length < 8) {
          alert('Mật khẩu phải có ít nhất 8 ký tự!');
          return;
        }

        if (mat_khau_moi !== confirmPassword) {
          document.getElementById('match-error').classList.remove('hidden');
          return;
        }

        const btn = document.getElementById('reset-btn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang xử lý...';

        try {
          const response = await fetch(`${API_URL}/auth/reset-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: resetEmail, mat_khau_moi })
          });

          const data = await response.json();

          if (data.success) {
            alert('Đặt lại mật khẩu thành công! Vui lòng đăng nhập với mật khẩu mới.');
            // Không lưu email vào localStorage để tránh lỗi logic
            window.location.href = 'login.html';
          } else {
            alert(data.message || 'Đặt lại mật khẩu thất bại!');
          }
        } catch (error) {
          alert('Lỗi kết nối: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }

      // Gửi lại OTP
      async function handleResendResetOTP() {
        try {
          const response = await fetch(`${API_URL}/auth/forgot-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: resetEmail })
          });

          const data = await response.json();

          if (data.success) {
            alert('Mã OTP mới đã được gửi!');
            startCountdown();
          } else {
            alert(data.message || 'Gửi lại OTP thất bại!');
          }
        } catch (error) {
          alert('Lỗi kết nối: ' + error.message);
        }
      }

      // Đếm ngược
      function startCountdown() {
        let seconds = 60;
        const resendBtn = document.getElementById('resend-btn');
        const countdownEl = document.getElementById('countdown');
        
        resendBtn.disabled = true;
        resendBtn.innerHTML = `Gửi lại (<span id="countdown">${seconds}</span>s)`;
        
        countdownTimer = setInterval(() => {
          seconds--;
          document.getElementById('countdown').textContent = seconds;
          
          if (seconds <= 0) {
            clearInterval(countdownTimer);
            resendBtn.disabled = false;
            resendBtn.innerHTML = 'Gửi lại';
          }
        }, 1000);
      }

      // Toggle password visibility
      function togglePassword(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);
        
        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
        } else {
          input.type = 'password';
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
        }
      }

      // Password strength checker
      document.getElementById('new-password').addEventListener('input', function(e) {
        const password = e.target.value;
        const strengthDiv = document.getElementById('password-strength');
        
        if (password.length === 0) {
          strengthDiv.classList.add('hidden');
          return;
        }
        
        strengthDiv.classList.remove('hidden');
        
        let strength = 0;
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
        if (/\d/.test(password)) strength++;
        if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength++;
        
        const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500'];
        const texts = ['Yếu', 'Trung bình', 'Khá', 'Mạnh'];
        
        for (let i = 1; i <= 4; i++) {
          const bar = document.getElementById(`str${i}`);
          bar.className = `h-1 flex-1 rounded ${i <= strength ? colors[strength - 1] : 'bg-gray-200'}`;
        }
        
        document.getElementById('strength-text').textContent = strength > 0 ? `Độ mạnh: ${texts[strength - 1]}` : '';
      });

      // Check password match
      document.getElementById('confirm-password').addEventListener('input', function(e) {
        const newPass = document.getElementById('new-password').value;
        const confirmPass = e.target.value;
        const errorEl = document.getElementById('match-error');
        
        if (confirmPass && newPass !== confirmPass) {
          errorEl.classList.remove('hidden');
        } else {
          errorEl.classList.add('hidden');
        }
      });

      // Auto-format OTP input
      document.getElementById('reset-otp').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
      });
    </script>
  </body>
</html>

