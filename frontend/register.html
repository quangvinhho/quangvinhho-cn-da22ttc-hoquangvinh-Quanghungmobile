<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng ký - QuangHưng Mobile</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
    <style>
      * { font-family: 'Roboto', sans-serif; }
      body { position: relative; min-height: 100vh; }
      body::before {
        content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(135deg, #e41e26, #c5111a);
        background-image: url('./images/anhnen.jpeg');
        background-size: cover; background-position: center; z-index: -2;
      }

      /* Hiệu ứng tuyết rơi Giáng sinh */
      .snowflake {
        position: fixed;
        top: -10px;
        color: #fff;
        font-size: 1em;
        text-shadow: 0 0 5px #fff;
        pointer-events: none;
        z-index: 1000;
        animation: fall linear forwards;
      }

      @keyframes fall {
        0% {
          opacity: 1;
          transform: translateY(0) rotate(0deg);
        }
        100% {
          opacity: 0.3;
          transform: translateY(100vh) rotate(360deg);
        }
      }
      body::after {
        content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.4); z-index: -1;
      }
      .glass-effect {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      }
      .step { display: none !important; }
      .step.active { display: block !important; animation: fadeIn 0.3s ease-out; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
  </head>
  <body class="flex items-center justify-center min-h-screen px-4 py-8">
    <!-- ===== PAGE LOADER - Hiệu ứng loading trang ===== -->
  <div id="page-loader">
    <div class="loader-logo">
      <img src="images/logo.png" alt="QuangHưng Mobile" onerror="this.style.display='none'">
    </div>
    <div class="loader-spinner"></div>
    <div class="loader-dots">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <div class="loader-text">
      <span>Đ</span><span>a</span><span>n</span><span>g</span><span>&nbsp;</span><span>t</span><span>ả</span><span>i</span><span>.</span><span>.</span><span>.</span>
    </div>
    <div class="loader-progress">
      <div class="loader-progress-bar"></div>
    </div>
  </div>

    <!-- Container cho hiệu ứng tuyết rơi -->
    <div id="snow-container"></div>
    
    <script>
      // Tạo hiệu ứng tuyết rơi Giáng sinh
      function createSnowflake() {
        const snowflake = document.createElement('div');
        snowflake.classList.add('snowflake');
        snowflake.innerHTML = ['❄', '❅', '❆', '✻', '✼', '❉'][Math.floor(Math.random() * 6)];
        snowflake.style.left = Math.random() * 100 + 'vw';
        snowflake.style.fontSize = (Math.random() * 15 + 10) + 'px';
        snowflake.style.animationDuration = (Math.random() * 3 + 4) + 's';
        snowflake.style.opacity = Math.random() * 0.6 + 0.4;
        document.body.appendChild(snowflake);
        
        setTimeout(() => {
          snowflake.remove();
        }, 7000);
      }
      
      // Tạo tuyết liên tục
      setInterval(createSnowflake, 150);
      // Tạo một số bông tuyết ban đầu
      for(let i = 0; i < 20; i++) {
        setTimeout(createSnowflake, i * 100);
      }
    </script>
    <div class="w-full max-w-md">
      <div class="glass-effect rounded-2xl p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Đăng ký</h2>

        <!-- Step 1: Form đăng ký -->
        <div id="step1" class="step active">
          <form id="register-form" class="space-y-3" onsubmit="handleSendOTP(event)" autocomplete="off">
            <!-- Avatar -->
            <div class="flex flex-col items-center mb-2">
              <div class="relative">
                <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden border-2 border-gray-300 cursor-pointer" onclick="document.getElementById('avatar').click()">
                  <i class="fas fa-user text-2xl text-gray-400" id="avatarIcon"></i>
                  <img id="avatarImg" src="" class="w-full h-full object-cover hidden">
                </div>
                <label for="avatar" class="absolute bottom-0 right-0 bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center cursor-pointer">
                  <i class="fas fa-camera text-xs"></i>
                </label>
                <input type="file" id="avatar" accept="image/*" class="hidden" onchange="previewAvatar(this)"/>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Họ và tên <span class="text-red-500">*</span></label>
              <input type="text" id="fullname" placeholder="Nhập họ và tên" class="w-full px-3 py-2 border rounded-lg outline-none focus:border-red-500" required />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email <span class="text-red-500">*</span></label>
              <input type="email" id="email" placeholder="Nhập email" class="w-full px-3 py-2 border rounded-lg outline-none focus:border-red-500" autocomplete="off" required />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Số điện thoại</label>
              <input type="tel" id="phone" placeholder="Nhập số điện thoại" class="w-full px-3 py-2 border rounded-lg outline-none focus:border-red-500" />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu <span class="text-red-500">*</span></label>
              <div class="relative">
                <input type="password" id="password" placeholder="Tối thiểu 8 ký tự" class="w-full px-3 py-2 pr-10 border rounded-lg outline-none focus:border-red-500" minlength="8" required />
                <button type="button" onclick="togglePassword('password', 'eye1')" class="absolute right-3 top-1/2 -translate-y-1/2">
                  <i id="eye1" class="fas fa-eye text-gray-400"></i>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Xác nhận mật khẩu <span class="text-red-500">*</span></label>
              <div class="relative">
                <input type="password" id="confirmPassword" placeholder="Nhập lại mật khẩu" class="w-full px-3 py-2 pr-10 border rounded-lg outline-none focus:border-red-500" required />
                <button type="button" onclick="togglePassword('confirmPassword', 'eye2')" class="absolute right-3 top-1/2 -translate-y-1/2">
                  <i id="eye2" class="fas fa-eye text-gray-400"></i>
                </button>
              </div>
            </div>

            <label class="flex items-start cursor-pointer">
              <input type="checkbox" id="terms" class="w-4 h-4 mt-0.5" required />
              <span class="ml-2 text-sm text-gray-600">Tôi đồng ý với <a href="#" class="text-red-600">Điều khoản</a></span>
            </label>

            <button type="submit" id="send-btn" class="w-full bg-red-600 text-white py-2.5 rounded-lg font-semibold hover:bg-red-700">
              <i class="fas fa-paper-plane mr-2"></i>Gửi mã xác thực
            </button>
          </form>

          <!-- Divider -->
          <div class="relative my-4">
            <div class="absolute inset-0 flex items-center">
              <div class="w-full border-t border-gray-300"></div>
            </div>
            <div class="relative flex justify-center text-sm">
              <span class="px-3 bg-white text-gray-500">hoặc</span>
            </div>
          </div>

          <!-- Google Sign Up Button -->
          <button onclick="handleGoogleSignup()" class="w-full bg-white border-2 border-gray-200 py-2.5 rounded-lg font-semibold text-gray-700 flex items-center justify-center gap-2 hover:border-blue-400 hover:shadow-md transition">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
              <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
              <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
              <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
            </svg>
            <span>Đăng ký với Google</span>
          </button>

          <div class="text-center mt-4">
            <p class="text-gray-600 text-sm">Đã có tài khoản? <a href="login.html" class="text-red-600 font-semibold">Đăng nhập</a></p>
          </div>
        </div>


        <!-- Step 2: Xác thực OTP -->
        <div id="step2" class="step">
          <div class="text-center mb-4">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
              <i class="fas fa-envelope-open-text text-2xl text-green-600"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800">Xác thực email</h3>
            <p class="text-gray-600 text-sm">Mã OTP đã gửi đến:</p>
            <p id="otp-email" class="font-semibold text-red-600"></p>
          </div>

          <form id="otp-form" class="space-y-4" onsubmit="handleVerifyOTP(event)">
            <input type="text" id="otp-code" maxlength="6" class="w-full px-4 py-3 border rounded-lg text-center text-2xl font-bold tracking-widest outline-none focus:border-red-500" placeholder="000000" required />

            <div class="text-center text-sm text-gray-500">
              Không nhận được? 
              <button type="button" id="resend-btn" onclick="handleResendOTP()" class="text-red-600 font-medium" disabled>
                Gửi lại (<span id="countdown">60</span>s)
              </button>
            </div>

            <div class="flex gap-2">
              <button type="button" onclick="goToStep(1)" class="flex-1 bg-gray-100 text-gray-700 py-2.5 rounded-lg font-semibold hover:bg-gray-200">
                <i class="fas fa-arrow-left mr-1"></i>Quay lại
              </button>
              <button type="submit" id="verify-btn" class="flex-1 bg-green-600 text-white py-2.5 rounded-lg font-semibold hover:bg-green-700">
                <i class="fas fa-check mr-1"></i>Xác thực
              </button>
            </div>
          </form>
        </div>
      </div>

      <div class="mt-4 text-center">
        <a href="index.html" class="text-white hover:text-white/80 text-sm"><i class="fas fa-arrow-left mr-1"></i>Về trang chủ</a>
      </div>
    </div>


    <script>
      const API_URL = 'http://localhost:3000/api';
      let registrationData = {};
      let countdownTimer;

      // Clear form khi load trang
      document.addEventListener('DOMContentLoaded', function() {
        localStorage.removeItem('registeredEmail');
        clearAllInputs();
        
        // Auto-format OTP
        document.getElementById('otp-code').addEventListener('input', function(e) {
          e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });
      });
      
      function clearAllInputs() {
        ['email', 'password', 'confirmPassword', 'fullname', 'phone'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = '';
        });
      }
      
      // Clear form sau 100ms để chắc chắn browser không điền lại
      setTimeout(clearAllInputs, 100);
      setTimeout(clearAllInputs, 500);

      function goToStep(step) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById(`step${step}`).classList.add('active');
      }

      function togglePassword(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);
        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
          input.type = 'password';
          icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
      }

      function previewAvatar(input) {
        if (input.files && input.files[0]) {
          const file = input.files[0];
          if (file.size > 5 * 1024 * 1024) {
            alert('Ảnh không được vượt quá 5MB!');
            input.value = '';
            return;
          }
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('avatarImg').src = e.target.result;
            document.getElementById('avatarImg').classList.remove('hidden');
            document.getElementById('avatarIcon').classList.add('hidden');
          };
          reader.readAsDataURL(file);
        }
      }

      // Step 1: Gửi OTP
      async function handleSendOTP(event) {
        event.preventDefault();
        
        const ho_ten = document.getElementById('fullname').value.trim();
        const email = document.getElementById('email').value.trim();
        const so_dt = document.getElementById('phone').value.trim();
        const mat_khau = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const avatarFile = document.getElementById('avatar').files[0];

        // Validate
        if (!ho_ten || !email || !mat_khau) {
          alert('Vui lòng điền đầy đủ thông tin!');
          return;
        }
        if (mat_khau !== confirmPassword) {
          alert('Mật khẩu xác nhận không khớp!');
          return;
        }
        if (mat_khau.length < 8) {
          alert('Mật khẩu phải có ít nhất 8 ký tự!');
          return;
        }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          alert('Email không hợp lệ!');
          return;
        }
        if (so_dt && !/^(0[3|5|7|8|9])[0-9]{8}$/.test(so_dt)) {
          alert('Số điện thoại không hợp lệ!');
          return;
        }

        // Lưu data
        registrationData = { ho_ten, email, so_dt, mat_khau, avatarFile };

        const btn = document.getElementById('send-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang gửi...';

        try {
          const response = await fetch(`${API_URL}/auth/send-otp`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, ho_ten })
          });
          const data = await response.json();

          if (data.success) {
            document.getElementById('otp-email').textContent = email;
            goToStep(2);
            startCountdown();
            document.getElementById('otp-code').focus();
          } else {
            alert(data.message || 'Gửi OTP thất bại!');
          }
        } catch (error) {
          alert('Lỗi kết nối: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Gửi mã xác thực';
        }
      }

      // Step 2: Xác thực OTP
      async function handleVerifyOTP(event) {
        event.preventDefault();
        
        const otp = document.getElementById('otp-code').value.trim();
        if (!otp || otp.length !== 6) {
          alert('Vui lòng nhập mã OTP 6 số!');
          return;
        }

        const btn = document.getElementById('verify-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Đang xác thực...';

        try {
          const response = await fetch(`${API_URL}/auth/verify-otp`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: registrationData.email, otp })
          });
          const data = await response.json();

          if (data.success) {
            await completeRegistration();
          } else {
            alert(data.message || 'Mã OTP không đúng!');
          }
        } catch (error) {
          alert('Lỗi kết nối: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-check mr-1"></i>Xác thực';
        }
      }

      // Hoàn tất đăng ký
      async function completeRegistration() {
        const { ho_ten, email, so_dt, mat_khau, avatarFile } = registrationData;
        
        const formData = new FormData();
        formData.append('ho_ten', ho_ten);
        formData.append('email', email);
        formData.append('so_dt', so_dt);
        formData.append('mat_khau', mat_khau);
        if (avatarFile) formData.append('avt', avatarFile);

        const response = await fetch(`${API_URL}/auth/register`, {
          method: 'POST',
          body: formData
        });
        const data = await response.json();

        if (data.success) {
          localStorage.setItem('registeredEmail', email);
          alert('Đăng ký thành công!');
          window.location.href = 'login.html?registered=true';
        } else {
          alert(data.message || 'Đăng ký thất bại!');
        }
      }

      // Gửi lại OTP
      async function handleResendOTP() {
        try {
          const response = await fetch(`${API_URL}/auth/send-otp`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: registrationData.email, ho_ten: registrationData.ho_ten })
          });
          const data = await response.json();
          if (data.success) {
            alert('Mã OTP mới đã được gửi!');
            startCountdown();
          } else {
            alert(data.message || 'Gửi lại thất bại!');
          }
        } catch (error) {
          alert('Lỗi: ' + error.message);
        }
      }

      function startCountdown() {
        let seconds = 60;
        const btn = document.getElementById('resend-btn');
        const countdownEl = document.getElementById('countdown');
        btn.disabled = true;
        
        if (countdownTimer) clearInterval(countdownTimer);
        countdownTimer = setInterval(() => {
          seconds--;
          countdownEl.textContent = seconds;
          if (seconds <= 0) {
            clearInterval(countdownTimer);
            btn.disabled = false;
            btn.innerHTML = 'Gửi lại';
          }
        }, 1000);
      }

      // Đăng ký bằng Google
      function handleGoogleSignup() {
        window.location.href = `${API_URL}/auth/google/register`;
      }
      
      // Xử lý thông báo lỗi từ Google OAuth
      document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');
        const message = urlParams.get('message');
        
        if (error === 'not_registered' && message) {
          showErrorMessage(decodeURIComponent(message));
          window.history.replaceState({}, document.title, 'register.html');
        } else if (error === 'email_exists' && message) {
          showErrorMessage(decodeURIComponent(message));
          window.history.replaceState({}, document.title, 'register.html');
        }
      });
      
      function showErrorMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 z-50';
        messageDiv.style.animation = 'fadeIn 0.3s ease-out';
        messageDiv.innerHTML = `
          <i class="fas fa-exclamation-circle text-xl"></i>
          <span class="font-medium">${message}</span>
          <button onclick="this.parentElement.remove()" class="ml-2 hover:text-gray-200">
            <i class="fas fa-times"></i>
          </button>
        `;
        document.body.appendChild(messageDiv);
        
        // Tự động ẩn sau 5 giây
        setTimeout(() => {
          if (messageDiv.parentElement) {
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translate(-50%, -20px)';
            messageDiv.style.transition = 'all 0.3s ease-out';
            setTimeout(() => messageDiv.remove(), 300);
          }
        }, 5000);
      }
    </script>

    <!-- AI Chatbot -->
    <link rel="stylesheet" href="components/ai-chatbot.css">
    <script src="components/ai-chatbot.js"></script>
    <!-- Main JS - Page Loader -->
  <script src="main.js"></script>
</body>
</html>

